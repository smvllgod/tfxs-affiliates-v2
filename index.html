<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="theme-color" content="#f5f5f7">
    <script>((t)=>{if(t==="light"){document.documentElement.classList.add("light-theme")};var m=document.querySelector('meta[name="theme-color"]');if(m)m.content=t==="light"?"#f5f5f7":"#050505"})(localStorage.getItem("tfxs_theme")||"light")</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TFXS Affiliate | Elite Dashboard Pro</title>
    <link rel="icon" type="image/svg+xml" href="assets/logo.svg">
    <link rel="manifest" href="/manifest.json">
    <meta property="og:title" content="TFXS Affiliates — Elite Dashboard">
    <meta property="og:description" content="Premium affiliate management dashboard for top-tier forex CPA partners.">
    <meta property="og:image" content="assets/logo.svg">
    <meta property="og:type" content="website">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://code.highcharts.com/11/highcharts.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <link rel="stylesheet" href="css/shared.css">
    <!-- D3.js and TopoJSON for Globe -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#fff1f2',
                            100: '#ffe4e6',
                            500: '#ef4444', 
                            600: '#dc2626',
                            900: '#7f1d1d',
                            neon: '#ff3333',
                            yellow: '#fbbf24',
                            dark: '#050505',
                            panel: '#0A0A0A'
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        scroll: {
                            '0%': { transform: 'translateX(0)' },
                            '100%': { transform: 'translateX(-50%)' },
                        },
                        shimmer: {
                            '0%': { transform: 'translateX(-150%) skewX(12deg)' },
                            '100%': { transform: 'translateX(250%) skewX(12deg)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #050505;
            color: #d4d4d8;
            overscroll-behavior: none;
        }

        .glass-hover {
            transition: all 0.35s cubic-bezier(0.4,0,0.2,1);
        }
        .glass-hover:hover {
            background: rgba(30, 30, 30, 0.8);
            border-color: rgba(220, 38, 38, 0.35);
            transform: translateY(-3px) scale(1.01);
            box-shadow: 0 12px 36px -10px rgba(220, 38, 38, 0.22), 0 0 0 1px rgba(220,38,38,0.12);
        }

        /* Skeleton Loader */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.04) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.04) 75%);
            background-size: 200% 100%;
            animation: skeletonPulse 1.5s ease-in-out infinite;
            border-radius: 4px;
            color: transparent !important;
            user-select: none;
            pointer-events: none;
        }
        @keyframes skeletonPulse {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* KPI Tooltip */
        .kpi-tooltip {
            position: relative;
        }
        .kpi-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%) translateY(4px);
            background: rgba(10,10,10,0.95);
            border: 1px solid rgba(255,255,255,0.12);
            color: #d4d4d8;
            font-size: 10px;
            font-weight: 400;
            font-family: 'Inter', sans-serif;
            padding: 6px 10px;
            border-radius: 8px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 50;
            backdrop-filter: blur(12px);
        }
        .kpi-tooltip:hover::after {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Sparkline container */
        .sparkline-container {
            height: 24px;
            margin-top: 6px;
            opacity: 0.7;
        }
        .sparkline-container svg {
            width: 100%;
            height: 100%;
        }

        .primary-glow {
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.3);
        }

        .btn-gradient {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            position: relative;
            overflow: hidden;
        }
        
        .btn-gradient::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        
        .btn-gradient:hover::after {
            left: 100%;
        }

        .text-glow {
            text-shadow: 0 0 20px rgba(220, 38, 38, 0.5);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #dc2626; }

        /* Custom Flatpickr Theme */
        .flatpickr-calendar {
            background: rgba(20, 20, 20, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5) !important;
            font-family: 'Inter', sans-serif !important;
            border-radius: 16px !important;
        }
        .flatpickr-calendar.arrowTop:before, .flatpickr-calendar.arrowTop:after {
            border-bottom-color: rgba(255, 255, 255, 0.1) !important;
        }
        .flatpickr-months .flatpickr-month {
            background: transparent !important;
            color: #fff !important;
            fill: #fff !important;
        }
        .flatpickr-current-month .flatpickr-monthDropdown-months,
        .flatpickr-current-month input.cur-year {
            color: #fff !important;
            font-weight: 700 !important;
        }
        .flatpickr-weekdays {
            background: transparent !important;
        }
        .flatpickr-weekday {
            color: #71717a !important;
            font-weight: 600 !important;
        }
        .flatpickr-day {
            color: #d4d4d8 !important;
            border-radius: 8px !important;
        }
        .flatpickr-day:hover {
            background: rgba(239, 68, 68, 0.2) !important;
            border-color: transparent !important;
        }
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange, .flatpickr-day.focus, .flatpickr-day.nextMonthDay:hover, .flatpickr-day.prevMonthDay:hover {
            background: #dc2626 !important;
            border-color: #dc2626 !important;
            color: white !important;
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.4) !important;
        }
        .flatpickr-day.inRange {
            background: rgba(239, 68, 68, 0.1) !important;
            border-color: transparent !important;
            box-shadow: -5px 0 0 rgba(239, 68, 68, 0.1), 5px 0 0 rgba(239, 68, 68, 0.1) !important;
        }
        .flatpickr-next-month, .flatpickr-prev-month {
            fill: #ef4444 !important;
            color: #ef4444 !important;
        }
        .flatpickr-next-month:hover svg, .flatpickr-prev-month:hover svg {
            fill: #fff !important;
        }
        .flatpickr-current-month .numInputWrapper span.arrowUp:after {
            border-bottom-color: #ef4444 !important;
        }
        .flatpickr-current-month .numInputWrapper span.arrowDown:after {
            border-top-color: #ef4444 !important;
        }

        /* Custom Select Styling */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: #0d0d0d;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            padding-right: 2.5rem !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: white;
            border-radius: 0.5rem;
        }
        
        select:focus {
            border-color: #ef4444 !important; 
            outline: none;
        }
        
        /* For Firefox */
        select option {
            background-color: #0d0d0d;
            color: white;
            padding: 10px;
        }
    </style>
</head>
<body class="antialiased font-sans min-h-screen relative overflow-x-hidden selection:bg-brand-500 selection:text-white pb-20">
<!-- Dropdown portals — outside all stacking contexts -->
<div id="broker-select-dropdown" class="hidden fixed min-w-[180px] rounded-xl border border-white/10 bg-[#111] shadow-2xl overflow-hidden" style="z-index: 99999;">
    <div id="broker-select-options" class="max-h-48 overflow-y-auto py-1"></div>
</div>
<div id="timeframe-dropdown-portal" class="hidden fixed w-52 rounded-xl border border-white/10 bg-[#111] shadow-2xl overflow-hidden" style="z-index: 99999;"></div>
<div id="broker-filter-portal" class="hidden fixed w-52 rounded-xl border border-white/10 bg-[#111] shadow-2xl overflow-hidden" style="z-index: 99999;"></div>

    <div class="halo-bg"></div>

    <div class="relative">
    <!-- Top Navigation -->
    <nav class="sticky top-0 z-50 w-full glass-panel border-b-0 border-white/5 py-3 sm:py-4">
        <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-12 flex items-center justify-between gap-3 sm:gap-4 relative">
            <div class="flex items-center gap-4 sm:gap-10">
                <a href="/" class="flex items-center gap-2 group cursor-pointer no-underline">
                    <img src="assets/logo.svg" alt="TFXS Logo" class="w-8 h-8 sm:w-10 sm:h-10 object-contain drop-shadow-[0_0_15px_rgba(220,38,38,0.5)]">
                    <span class="hidden sm:inline text-lg sm:text-xl font-bold tracking-tight text-white group-hover:text-brand-500 transition-colors">TFXS<span class="opacity-50 font-light"> AFFILIATES</span></span>
                </a>

                <div id="nav-links" class="hidden md:flex items-center gap-1 bg-white/5 p-1 rounded-lg border border-white/5">
                    <a href="/" class="px-4 py-1.5 text-xs font-semibold text-brand-500 bg-white/10 rounded-md shadow-sm" data-i18n="nav.dashboard">Dashboard</a>
                    <a href="/reports" class="px-4 py-1.5 text-xs font-medium text-gray-400 hover:text-white transition rounded-md hover:bg-white/5" data-i18n="nav.reports">Reports</a>
                    <a href="/deals" class="px-4 py-1.5 text-xs font-medium text-gray-400 hover:text-white transition rounded-md hover:bg-white/5" data-i18n="nav.deals">Deals</a>
                    <a href="/assets" class="px-4 py-1.5 text-xs font-medium text-gray-400 hover:text-white transition rounded-md hover:bg-white/5" data-i18n="nav.assets">Assets</a>
                    <a href="/settings" class="px-4 py-1.5 text-xs font-medium text-gray-400 hover:text-white transition rounded-md hover:bg-white/5" data-i18n="nav.settings">Settings</a>
                </div>
            </div>

            <div class="flex items-center gap-3 sm:gap-6">
                <div class="hidden lg:flex flex-col items-end">
                    <span class="text-[10px] text-gray-500 font-mono btn-primary uppercase tracking-wider" data-i18n="nav.serverTime">Server Time</span>
                    <span id="server-time" class="text-xs font-mono font-bold text-white">--:--:--</span>
                </div>
                <div class="h-8 w-[1px] bg-white/10 hidden lg:block"></div>
                
                <!-- Language Selector -->
                <div id="lang-selector-anchor"></div>
                <!-- Theme Toggle -->
                <div id="theme-toggle-anchor"></div>

                <!-- Notification Bell -->
                <button class="relative p-2 text-gray-400 hover:text-white transition-colors rounded-lg hover:bg-white/5 notification-bell-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                    <span id="notif-badge" class="absolute -top-0.5 -right-0.5 min-w-[18px] h-[18px] flex items-center justify-center rounded-full bg-brand-500 text-white text-[9px] font-bold shadow-[0_0_8px_#ef4444]" style="display:none;">0</span>
                </button>

                <!-- Mobile Menu Toggle -->
                <button id="mobile-menu-toggle" class="md:hidden p-2 text-gray-400 hover:text-white transition rounded-lg hover:bg-white/5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>

                <a id="nav-avatar-link" href="/settings" class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition-opacity">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-bold text-white leading-none nav-display-name">—</p>
                        <p class="text-[10px] text-brand-500 font-mono mt-1 nav-afp-label">—</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-gradient-to-b from-gray-700 to-black border border-white/20 relative overflow-hidden ring-2 ring-brand-500/20">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=default" alt="Avatar" class="w-full h-full object-cover opacity-80">
                    </div>
                </a>
            </div>
        </div>
    </nav>

    <!-- Connecting overlay — full-page, transparent, fixed at top -->
    <div id="connecting-overlay" class="fixed inset-0 z-[9998]" style="background:rgba(5,5,5,0.85); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);">
        <div class="flex items-center justify-center gap-3 px-6 py-3 mt-[72px]" style="background:linear-gradient(90deg, transparent, rgba(220,38,38,0.06), transparent);">
            <div class="relative w-5 h-5 flex-shrink-0">
                <div class="absolute inset-0 rounded-full border-2 border-white/10"></div>
                <div class="absolute inset-0 rounded-full border-2 border-t-red-500 animate-spin"></div>
            </div>
            <p class="text-xs font-mono text-gray-400 tracking-wider" data-i18n="dash.connecting">Connecting to live data<span class="connecting-dots"></span></p>
            <p class="text-[10px] text-gray-600 ml-1" data-i18n="dash.mayTake">— may take a few seconds</p>
        </div>
    </div>
    <style>
        @keyframes connectDots { 0%{content:''} 25%{content:'.'} 50%{content:'..'} 75%{content:'...'} }
        .connecting-dots::after { content:''; animation: connectDots 1.5s steps(4,end) infinite; }
    </style>

    <main class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-12 mt-6 sm:mt-12 space-y-6 sm:space-y-8 relative">

        <!-- Top Dashboard Section -->
        <header class="flex flex-col lg:flex-row justify-between items-stretch gap-4 sm:gap-6 animate-fade-in-up" style="animation-delay: 0s;">
            <!-- My Balance Box -->
            <div class="glass-panel p-6 rounded-2xl flex-1 border border-white/5 relative overflow-visible">
                <div class="flex items-center gap-2 text-gray-400 mb-2 relative">
                    <span class="text-sm font-medium" data-i18n="dash.myBalance">My Balance</span>
                    <button id="balance-info-btn" class="relative hover:text-white transition-colors cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </button>
                    <!-- Balance Info Popup -->
                    <div id="balance-info-popup" class="fixed z-[9999] bg-[#111] border border-white/10 rounded-xl p-4 shadow-2xl min-w-[260px] hidden opacity-0 transition-all duration-200" style="backdrop-filter: blur(20px);">
                        <div class="space-y-3">
                            <div class="flex items-center gap-3">
                                <div class="w-7 h-7 rounded-lg bg-green-500/10 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg></div>
                                <div class="flex-1">
                                    <p class="text-[10px] text-gray-500 uppercase tracking-wider" data-i18n="payout.available">Available for Payout</p>
                                    <p class="text-sm font-bold text-white font-mono" id="popup-available">$0.00</p>
                                    <p class="text-[8px] text-gray-600" id="popup-available-sub">From previous month(s)</p>
                                </div>
                            </div>
                            <div class="h-[1px] bg-white/5" id="popup-accruing-divider"></div>
                            <div class="flex items-center gap-3" id="popup-accruing-row">
                                <div class="w-7 h-7 rounded-lg bg-amber-500/10 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                                <div class="flex-1">
                                    <p class="text-[10px] text-gray-500 uppercase tracking-wider" id="popup-accruing-label">Accruing This Month</p>
                                    <p class="text-sm font-bold text-amber-400 font-mono" id="popup-accruing">$0.00</p>
                                    <p class="text-[8px] text-gray-600" id="popup-accruing-sub">Available next month</p>
                                </div>
                            </div>
                            <div class="h-[1px] bg-white/5"></div>
                            <div class="flex items-center gap-3">
                                <div class="w-7 h-7 rounded-lg bg-yellow-500/10 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                                <div class="flex-1">
                                    <p class="text-[10px] text-gray-500 uppercase tracking-wider" data-i18n="payout.earned">Lifetime Earned</p>
                                    <p class="text-sm font-bold text-white font-mono" id="popup-lifetime">$0.00</p>
                                </div>
                            </div>
                            <div class="h-[1px] bg-white/5"></div>
                            <div class="flex items-center gap-3">
                                <div class="w-7 h-7 rounded-lg bg-brand-500/10 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-brand-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                                <div class="flex-1">
                                    <p class="text-[10px] text-gray-500 uppercase tracking-wider" id="popup-paid-label" data-i18n="payout.paid">Total Paid</p>
                                    <p class="text-sm font-bold text-white font-mono" id="popup-paid">$0.00</p>
                                </div>
                            </div>
                            <div class="h-[1px] bg-white/5"></div>
                            <div class="flex items-center gap-3" id="popup-last-row">
                                <div class="w-7 h-7 rounded-lg bg-blue-500/10 flex items-center justify-center" id="popup-last-icon"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></div>
                                <div class="flex-1">
                                    <p class="text-[10px] text-gray-500 uppercase tracking-wider" id="popup-last-label" data-i18n="payout.nextPayout">Next Payout</p>
                                    <p class="text-sm font-bold text-white font-mono" id="popup-next-payout">--</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-4xl font-bold font-mono text-white tracking-tight" id="balance-display">$0.00</div>
                <div class="flex items-center gap-2 mt-4" id="balance-change-row">
                    <span class="text-xs font-bold text-green-500 bg-green-500/10 px-1.5 py-0.5 rounded border border-green-500/20 inline-flex items-center gap-0.5" id="balance-change-badge"><svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7 17l9.2-9.2M17 17V7H7"/></svg> 0%</span>
                </div>
                <button id="request-payout-btn" onclick="openPayoutModal()" class="mt-4 w-full btn-gradient px-4 py-2.5 rounded-xl text-[11px] font-bold text-white uppercase tracking-wider hover:opacity-90 transition flex items-center justify-center gap-2 shadow-lg shadow-brand-600/20 transform active:scale-[0.97]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    <span data-i18n="dash.requestPayout">Request Payout</span>
                </button>
                <!-- KYC Warning (shown when KYC not approved) -->
                <div id="kyc-payout-warning" class="hidden mt-3 p-2.5 rounded-xl bg-amber-500/5 border border-amber-500/20">
                    <a href="/settings#kyc-section" class="flex items-center gap-2 group">
                        <svg class="w-4 h-4 text-amber-400 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                        <span class="text-[10px] text-amber-300 group-hover:text-amber-200 transition-colors">Complete KYC verification to enable payouts →</span>
                    </a>
                </div>
            </div>

            <!-- Quick Share Box -->
            <div class="glass-panel p-6 rounded-2xl flex-[2] border border-white/5 flex flex-col justify-between">
                <div class="flex justify-between items-start mb-4">
                     <span class="text-sm font-bold text-white" data-i18n="dash.quickShare">Quick Share</span>
                     <span class="text-[9px] text-gray-600 uppercase tracking-wider font-bold" data-i18n="dash.yourRefLinks">Your Referral Links</span>
                </div>
                <div class="flex flex-col sm:flex-row gap-3 items-stretch">
                    <div class="sm:w-[180px] flex-shrink-0">
                        <label class="text-[10px] text-gray-500 uppercase tracking-wider font-bold mb-1 block" data-i18n="dash.selectBroker">Select Broker</label>
                        <div class="custom-select relative" id="broker-select-wrapper">
                            <button type="button" id="broker-select-btn" class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white text-left flex items-center justify-between gap-2 hover:border-white/20 transition-colors focus:outline-none focus:border-brand-500">
                                <span id="broker-select-label">Loading brokers...</span>
                                <svg class="w-3.5 h-3.5 text-gray-500 shrink-0 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </button>
                            <input type="hidden" id="broker-select" value="">
                        </div>
                    </div>
                     <div class="flex-1 flex items-end gap-2 min-w-0">
                        <div class="flex-1 min-w-0 bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-gray-400 truncate font-mono" id="affiliate-link" title="">
                            Select a broker
                        </div>
                        <button id="copy-link-btn" data-copy="" class="flex-shrink-0 flex items-center gap-2 px-4 py-2 rounded-lg border border-brand-500/30 text-brand-500 hover:bg-brand-500 hover:text-white transition-all text-sm font-medium group">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                            <span data-i18n="dash.copy">Copy</span>
                        </button>
                        <button id="qr-btn" class="p-2 rounded-lg border border-white/10 text-gray-400 hover:text-white hover:border-white/30 transition-all" title="Show QR Code">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                        </button>
                    </div>
                </div>
                <!-- Contact Admin -->
                <div id="contact-admin-row" class="hidden mt-3 pt-3 border-t border-white/5 flex items-center justify-between">
                    <span class="text-[10px] text-gray-500 uppercase tracking-wider font-bold">Need help?</span>
                    <div class="relative" id="contact-admin-wrap">
                        <button id="contact-admin-btn" class="flex items-center gap-2 px-3 py-1.5 rounded-lg border border-white/10 text-gray-400 hover:text-white hover:border-white/20 transition-all text-xs font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                            <span data-i18n="dash.contactAdmin">Contact Affiliate Manager</span>
                        </button>
                        <div id="contact-admin-dropdown" class="hidden absolute right-0 bottom-full mb-2 w-56 glass-panel rounded-xl border border-white/10 shadow-2xl z-50 overflow-hidden">
                            <a id="contact-email-link" href="#" class="flex items-center gap-3 px-4 py-3 text-xs text-gray-300 hover:bg-white/5 hover:text-white transition-colors">
                                <div class="w-8 h-8 rounded-lg bg-brand-500/10 border border-brand-500/20 flex items-center justify-center flex-shrink-0">
                                    <svg class="w-4 h-4 text-brand-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                                </div>
                                <div>
                                    <p class="font-medium">Email</p>
                                    <p id="contact-email-display" class="text-[10px] text-gray-500 font-mono truncate max-w-[150px]">—</p>
                                </div>
                            </a>
                            <a id="contact-telegram-link" href="#" target="_blank" rel="noopener" class="flex items-center gap-3 px-4 py-3 text-xs text-gray-300 hover:bg-white/5 hover:text-white transition-colors border-t border-white/5">
                                <div class="w-8 h-8 rounded-lg bg-blue-500/10 border border-blue-500/20 flex items-center justify-center flex-shrink-0">
                                    <svg class="w-4 h-4 text-blue-400" viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                                </div>
                                <div>
                                    <p class="font-medium">Telegram</p>
                                    <p id="contact-telegram-display" class="text-[10px] text-gray-500 font-mono truncate max-w-[150px]">—</p>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Filters & Date Range -->
        <div class="flex flex-wrap items-center gap-4 animate-fade-in-up" style="animation-delay: 0.05s;">
            <div class="glass-panel px-4 py-2 rounded-lg flex items-center gap-2 border-white/10">
                <span class="text-xs text-gray-400" data-i18n="dash.timeframe">Timeframe:</span>
                <div class="custom-select relative" id="timeframe-wrapper">
                    <button type="button" id="timeframe-btn" class="bg-transparent text-sm font-medium text-white flex items-center gap-2 cursor-pointer outline-none">
                        <span id="timeframe-label">Month to Date</span>
                        <svg class="w-3.5 h-3.5 text-gray-500 shrink-0 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <!-- Timeframe dropdown rendered via portal for z-index -->
                    <input type="hidden" id="dashboard-timeframe" value="mtd">
                </div>
            </div>

            <!-- Broker Filter -->
            <div class="glass-panel px-4 py-2 rounded-lg flex items-center gap-2 border-white/10">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-brand-500 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
                <div class="custom-select relative" id="broker-filter-wrapper">
                    <button type="button" id="broker-filter-btn" class="bg-transparent text-sm font-medium text-white flex items-center gap-2 cursor-pointer outline-none">
                        <span id="broker-filter-label">All Brokers</span>
                        <svg class="w-3.5 h-3.5 text-gray-500 shrink-0 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <input type="hidden" id="broker-filter" value="">
                </div>
            </div>

            
            <div class="glass-panel px-4 py-2 rounded-lg flex items-center gap-2 border-white/10">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-brand-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                 <input type="text" id="date-range" value="2026-02-01 to 2026-02-06" class="bg-transparent text-sm text-white border-none focus:ring-0 w-[200px] outline-none font-mono text-center">
            </div>

            <button id="update-dashboard-btn" class="bg-brand-600 hover:bg-brand-500 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg shadow-brand-500/20 transition-all w-full sm:w-auto" data-i18n="dash.update">
                Update
            </button>
        </div>

        <!-- KPI Grid -->
        <section class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 sm:gap-4 animate-fade-in-up" style="animation-delay: 0.1s;">
            <!-- KPI 1 -->
            <div class="glass-panel p-4 rounded-xl border-l-4 border-l-brand-500 glass-hover group cursor-pointer relative overflow-hidden bg-brand-500/5 kpi-tooltip" data-tooltip="Total commission earned from qualified conversions">
                <div class="absolute top-0 right-0 p-3 opacity-10 transition-all duration-300 group-hover:opacity-100 group-hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-brand-500 group-hover:text-brand-yellow drop-shadow-[0_0_10px_rgba(251,191,36,0.3)] transition-colors duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <p class="text-xs font-medium text-gray-400 mb-1 group-hover:text-brand-yellow transition-colors" data-i18n="dash.commission">Commission</p>
                <div class="flex items-baseline gap-2">
                    <span id="kpi-commission" class="text-xl lg:text-2xl font-mono font-bold text-white skeleton">$0.00</span>
                    <span class="text-[10px] font-bold text-green-500 bg-green-500/10 px-1.5 rounded inline-flex items-center gap-0.5" id="kpi-commission-badge"><svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7 17l9.2-9.2M17 17V7H7"/></svg> 0%</span>
                </div>
            </div>

            <!-- KPI 2 -->
            <div class="glass-panel p-4 rounded-xl glass-hover group cursor-pointer relative overflow-hidden kpi-tooltip" data-tooltip="New user sign-ups from your affiliate links">
                <div class="absolute top-0 right-0 p-3 opacity-10 transition-all duration-300 group-hover:opacity-100 group-hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white group-hover:text-brand-yellow drop-shadow-[0_0_10px_rgba(251,191,36,0.3)] transition-colors duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                </div>
                <p class="text-xs font-medium text-gray-400 mb-1 group-hover:text-brand-yellow transition-colors" data-i18n="dash.registrations">Registrations</p>
                <div class="flex items-baseline gap-2">
                    <span id="kpi-registrations" class="text-xl lg:text-2xl font-mono font-bold text-white skeleton">0</span>
                    <span class="text-[10px] font-bold text-green-500 bg-green-500/10 px-1.5 rounded inline-flex items-center gap-0.5" id="kpi-reg-badge"><svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7 17l9.2-9.2M17 17V7H7"/></svg> 0%</span>
                </div>
            </div>

            <!-- KPI 3 -->
            <div class="glass-panel p-4 rounded-xl glass-hover group cursor-pointer relative overflow-hidden kpi-tooltip" data-tooltip="First Time Deposits — users who funded their account">
                <div class="absolute top-0 right-0 p-3 opacity-10 transition-all duration-300 group-hover:opacity-100 group-hover:scale-110">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white group-hover:text-brand-yellow drop-shadow-[0_0_10px_rgba(251,191,36,0.3)] transition-colors duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
                </div>
                <p class="text-xs font-medium text-gray-400 mb-1 group-hover:text-brand-yellow transition-colors" data-i18n="dash.ftd">FTD</p>
                <div class="flex items-baseline gap-2">
                    <span id="kpi-ftd" class="text-xl lg:text-2xl font-mono font-bold text-white skeleton">0</span>
                    <span class="text-[10px] font-bold text-green-500 bg-green-500/10 px-1.5 rounded inline-flex items-center gap-0.5" id="kpi-ftd-badge"><svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7 17l9.2-9.2M17 17V7H7"/></svg> 0%</span>
                </div>
            </div>

            <!-- KPI 4 -->
            <div class="glass-panel p-4 rounded-xl glass-hover group cursor-pointer relative overflow-hidden kpi-tooltip" data-tooltip="Qualified FTDs — deposits above $200 that trigger commission">
                <div class="absolute top-0 right-0 p-3 opacity-10 transition-all duration-300 group-hover:opacity-100 group-hover:scale-110">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white group-hover:text-brand-yellow drop-shadow-[0_0_10px_rgba(251,191,36,0.3)] transition-colors duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <p class="text-xs font-medium text-gray-400 mb-1 group-hover:text-brand-yellow transition-colors" data-i18n="dash.qftd">QFTD</p>
                <div class="flex items-baseline gap-2">
                    <span id="kpi-qftd" class="text-xl lg:text-2xl font-mono font-bold text-white skeleton">0</span>
                    <span class="text-[10px] font-bold text-green-500 bg-green-500/10 px-1.5 rounded inline-flex items-center gap-0.5" id="kpi-qftd-badge"><svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7 17l9.2-9.2M17 17V7H7"/></svg> 0%</span>
                </div>
            </div>

            <!-- KPI 5 -->
            <div class="glass-panel p-4 rounded-xl glass-hover group cursor-pointer relative overflow-hidden kpi-tooltip" data-tooltip="Return on Investment — commission vs estimated ad spend">
                <div class="absolute top-0 right-0 p-3 opacity-10 transition-all duration-300 group-hover:opacity-100 group-hover:scale-110">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white group-hover:text-brand-yellow drop-shadow-[0_0_10px_rgba(251,191,36,0.3)] transition-colors duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                </div>
                <p class="text-xs font-medium text-gray-400 mb-1 group-hover:text-brand-yellow transition-colors" data-i18n="dash.roi">ROI</p>
                <div class="flex items-baseline gap-2">
                    <span id="kpi-roi" class="text-xl lg:text-2xl font-mono font-bold text-white skeleton">0.00</span>
                    <span class="text-[10px] font-bold text-green-500 bg-green-500/10 px-1.5 rounded inline-flex items-center gap-0.5" id="kpi-roi-badge"><svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7 17l9.2-9.2M17 17V7H7"/></svg> 0%</span>
                </div>
            </div>
        </section>

        <!-- ═══ ADMIN BUSINESS OVERVIEW (hidden for affiliates) ═══ -->
        <section id="admin-business-section" class="hidden animate-fade-in-up" style="animation-delay: 0.15s;">
            <!-- Business KPIs -->
            <div class="flex items-center gap-3 mb-4">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-brand-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                    <h2 class="text-base font-bold text-white uppercase tracking-wider">Business Overview</h2>
                </div>
                <span class="text-[9px] font-bold px-2 py-0.5 rounded-full bg-brand-500/20 text-brand-400 border border-brand-500/20 uppercase">Admin Only</span>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <!-- Revenue (Broker raw) -->
                <div class="glass-panel p-4 rounded-xl border-l-4 border-l-green-500 group cursor-pointer relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-30 transition">
                        <svg class="h-10 w-10 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z"/></svg>
                    </div>
                    <p class="text-[10px] font-bold text-green-400 uppercase tracking-wider mb-1">Revenue</p>
                    <span id="kpi-revenue" class="text-xl font-mono font-bold text-white">$0.00</span>
                    <p class="text-[9px] text-gray-500 mt-1">Broker revenue total</p>
                </div>
                <!-- Affiliate Cost -->
                <div class="glass-panel p-4 rounded-xl border-l-4 border-l-orange-500 group cursor-pointer relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-30 transition">
                        <svg class="h-10 w-10 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                    </div>
                    <p class="text-[10px] font-bold text-orange-400 uppercase tracking-wider mb-1">Affiliate Cost</p>
                    <span id="kpi-aff-cost" class="text-xl font-mono font-bold text-white">$0.00</span>
                    <p class="text-[9px] text-gray-500 mt-1">Owed to affiliates</p>
                </div>
                <!-- Net Profit -->
                <div class="glass-panel p-4 rounded-xl border-l-4 border-l-emerald-500 group cursor-pointer relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-30 transition">
                        <svg class="h-10 w-10 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                    <p class="text-[10px] font-bold text-emerald-400 uppercase tracking-wider mb-1">Net Profit</p>
                    <span id="kpi-profit" class="text-xl font-mono font-bold text-white">$0.00</span>
                    <p class="text-[9px] text-gray-500 mt-1">Revenue − Cost</p>
                </div>
                <!-- Margin -->
                <div class="glass-panel p-4 rounded-xl border-l-4 border-l-purple-500 group cursor-pointer relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-30 transition">
                        <svg class="h-10 w-10 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 107.5 7.5h-7.5V6z"/><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0013.5 3v7.5z"/></svg>
                    </div>
                    <p class="text-[10px] font-bold text-purple-400 uppercase tracking-wider mb-1">Margin</p>
                    <span id="kpi-margin" class="text-xl font-mono font-bold text-white">0%</span>
                    <p class="text-[9px] text-gray-500 mt-1">Profit / Revenue</p>
                </div>
            </div>

            <!-- Affiliate Performance Table -->
            <div class="glass-panel rounded-2xl overflow-hidden border border-white/5">
                <div class="p-4 border-b border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-brand-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                        <h3 class="text-sm font-bold text-white uppercase tracking-wider">Affiliate Performance</h3>
                    </div>
                    <button id="backfill-btn" onclick="backfillRawCommission()" class="text-[9px] font-bold uppercase px-3 py-1.5 rounded-lg bg-white/5 text-gray-400 hover:text-white hover:bg-white/10 border border-white/10 transition hidden">
                        <svg class="w-3 h-3 inline mr-1 -mt-px" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        Backfill Historical
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-[10px] uppercase tracking-wider text-gray-500 border-b border-white/5">
                                <th class="px-4 py-3 font-semibold">Affiliate</th>
                                <th class="px-4 py-3 font-semibold text-center">Reg</th>
                                <th class="px-4 py-3 font-semibold text-center">FTD</th>
                                <th class="px-4 py-3 font-semibold text-center">QFTD</th>
                                <th class="px-4 py-3 font-semibold text-right">Deposits</th>
                                <th class="px-4 py-3 font-semibold text-right">Revenue</th>
                                <th class="px-4 py-3 font-semibold text-right">Aff. Cost</th>
                                <th class="px-4 py-3 font-semibold text-right">Profit</th>
                                <th class="px-4 py-3 font-semibold text-right">Margin</th>
                            </tr>
                        </thead>
                        <tbody id="affiliate-perf-tbody" class="divide-y divide-white/5">
                            <tr><td colspan="9" class="px-4 py-8 text-center text-xs text-gray-600">Loading...</td></tr>
                        </tbody>
                        <tfoot id="affiliate-perf-tfoot" class="border-t border-white/10 bg-white/[0.02]">
                        </tfoot>
                    </table>
                </div>
            </div>
        </section>

        <!-- Chart Section (Full Width) -->
        <div class="glass-panel rounded-2xl p-4 md:p-5 flex flex-col border border-white/5 animate-fade-in-up" style="animation-delay: 0.2s;">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <h3 class="text-lg font-bold text-white" data-i18n="dash.revenueAnalytics">Revenue Analytics</h3>
                    <p class="text-[10px] text-gray-500 font-mono uppercase mt-0.5" data-i18n="dash.realTimeFeed">Real-time Data Feed</p>
                </div>
                <div id="chart-legend" class="flex items-center gap-5 flex-shrink-0">
                    <button onclick="toggleChartSeries(0)" class="chart-legend-item flex items-center gap-1.5 cursor-pointer opacity-100 transition" data-index="0">
                        <span class="w-2.5 h-2.5 rounded-full" style="background:#E53935"></span>
                        <span class="text-[11px] text-gray-400 font-medium tracking-wide" data-i18n="dash.commission">Commission</span>
                    </button>
                    <button onclick="toggleChartSeries(1)" class="chart-legend-item flex items-center gap-1.5 cursor-pointer opacity-100 transition" data-index="1">
                        <span class="w-2.5 h-2.5 rounded-full" style="background:#FBC02D"></span>
                        <span class="text-[11px] text-gray-400 font-medium tracking-wide" data-i18n="dash.registrations">Registrations</span>
                    </button>
                </div>
            </div>
            <div id="chartArea" class="relative w-full" style="min-height:380px;">
                <div id="revenueChartContainer" style="width:100%;height:100%;"></div>
            </div>
        </div>

        <!-- Globe & Activity Feed Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in-up" style="animation-delay: 0.25s;">
            <!-- Globe Card -->
            <div class="glass-panel rounded-2xl p-6 flex flex-col border border-white/5 bg-gradient-to-br from-brand-900/10 to-black/50">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-brand-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                         <h3 class="text-sm font-bold text-white uppercase tracking-widest" data-i18n="dash.liveActivity">Live Activity</h3>
                    </div>
                    <div class="flex items-center gap-3">
                         <button id="expand-globe-btn" class="text-xs text-gray-500 hover:text-white uppercase font-mono transition flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg>
                            <span data-i18n="dash.expand">Expand</span>
                         </button>
                         <span class="w-px h-3 bg-white/10"></span>
                         <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                            <span class="text-[10px] font-mono text-green-500" data-i18n="dash.online">ONLINE</span>
                        </div>
                    </div>
                </div>
                <!-- 3D Globe Container -->
                <div class="relative w-full h-[220px] bg-transparent rounded-lg overflow-hidden flex items-center justify-center cursor-move" id="globe-container">
                    <canvas id="globeCanvas"></canvas>
                    <div class="absolute inset-0 pointer-events-none bg-radial-gradient"></div>
                </div>
            </div>

            <!-- Activity Feed Card -->
            <div class="lg:col-span-2 glass-panel rounded-2xl p-6 flex flex-col border border-white/5">
                <div class="flex items-center gap-2 mb-4 pb-3 border-b border-white/5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-brand-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    <h3 class="text-sm font-bold text-white uppercase tracking-widest" data-i18n="dash.recentEvents">Recent Events</h3>
                </div>
                <ul id="activity-feed" class="space-y-4">
                    <!-- Populated by JS from real DB -->
                </ul>
            </div>
        </div>

        <!-- Table Grid -->
        <div class="glass-panel rounded-2xl overflow-hidden border border-white/5 animate-fade-in-up" style="animation-delay: 0.3s;">
             <div class="p-6 border-b border-white/5 flex flex-col gap-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-base font-bold text-white" data-i18n="dash.recentTx">Recent Transactions</h3>
                </div>
                <!-- Transaction Filters -->
                <div class="flex flex-wrap gap-3">
                    <div class="custom-select relative" id="txn-country-wrapper">
                        <button type="button" id="txn-country-btn" class="bg-black/30 border border-white/10 rounded-lg px-3 py-1.5 text-[11px] text-gray-300 flex items-center gap-2 min-w-[140px] hover:border-white/20 transition-colors">
                            <span id="txn-country-label">All Countries</span>
                            <svg class="w-3 h-3 text-gray-500 shrink-0 ml-auto transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </button>
                        <div id="txn-country-dropdown" class="hidden absolute left-0 top-full mt-1 w-56 z-50 rounded-xl border border-white/10 bg-[#111] shadow-2xl overflow-hidden">
                            <div id="txn-country-options" class="max-h-48 overflow-y-auto py-1">
                                <div class="custom-select-opt px-3 py-2 text-[11px] cursor-pointer hover:bg-white/10 transition text-gray-300 bg-white/5 font-medium" data-value="">All Countries</div>
                            </div>
                        </div>
                        <input type="hidden" id="txn-country-filter" value="">
                    </div>
                    <div class="custom-select relative" id="txn-amount-wrapper">
                        <button type="button" id="txn-amount-btn" class="bg-black/30 border border-white/10 rounded-lg px-3 py-1.5 text-[11px] text-gray-300 flex items-center gap-2 min-w-[130px] hover:border-white/20 transition-colors">
                            <span id="txn-amount-label">All Amounts</span>
                            <svg class="w-3 h-3 text-gray-500 shrink-0 ml-auto transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </button>
                        <div id="txn-amount-dropdown" class="hidden absolute left-0 top-full mt-1 w-44 z-50 rounded-xl border border-white/10 bg-[#111] shadow-2xl overflow-hidden">
                            <div id="txn-amount-options" class="max-h-48 overflow-y-auto py-1">
                                <div class="custom-select-opt px-3 py-2 text-[11px] cursor-pointer hover:bg-white/10 transition text-gray-300 bg-white/5 font-medium" data-value="">All Amounts</div>
                            </div>
                        </div>
                        <input type="hidden" id="txn-amount-filter" value="">
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-white/5 text-[10px] uppercase text-gray-500 font-mono">
                        <tr>
                            <th class="px-6 py-4 font-semibold tracking-wider" data-i18n="dash.userId">User ID</th>
                            <th class="px-6 py-4 font-semibold tracking-wider" data-i18n="dash.date">Date</th>
                            <th class="px-6 py-4 font-semibold tracking-wider" data-i18n="dash.type">Type</th>
                            <th class="px-6 py-4 font-semibold tracking-wider" data-i18n="dash.country">Country</th>
                            <th class="px-6 py-4 font-semibold tracking-wider text-right" data-i18n="dash.amount">Amount</th>
                            <th class="px-6 py-4 font-semibold tracking-wider text-center" data-i18n="dash.status">Status</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-tbody" class="text-xs divide-y divide-white/5 font-mono">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Country Distribution Chart -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 animate-fade-in-up" style="animation-delay: 0.35s;">
            <div class="glass-panel rounded-2xl p-6 border border-white/5">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-1">
                    <div class="min-w-0">
                        <h3 class="text-sm sm:text-base font-bold text-white truncate" id="donut-title" data-i18n="dash.regionalDist">Regional Distribution</h3>
                        <p class="text-[9px] sm:text-[10px] text-gray-500 font-mono uppercase mt-1 leading-snug" id="donut-subtitle" data-i18n="dash.regByRegion">Registrations by region</p>
                    </div>
                    <button id="donut-back-btn" class="hidden items-center gap-1.5 text-[10px] font-mono text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 border border-white/10 px-3 py-1.5 rounded-lg transition-all flex-shrink-0 self-start sm:self-center">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        <span data-i18n="dash.allRegions">All Regions</span>
                    </button>
                </div>
                <div id="countryDonutChart" style="min-height: 280px;"></div>
            </div>
            <div class="glass-panel rounded-2xl p-6 border border-white/5">
                <h3 class="text-base font-bold text-white mb-1" data-i18n="dash.top10">Top 10 Performing Countries</h3>
                <p class="text-[10px] text-gray-500 font-mono uppercase mb-4" data-i18n="dash.commPerCountry">Commission per country</p>
                <div id="countryBarChart" style="min-height: 280px;"></div>
            </div>
        </div>

    </main>

    <!-- Transaction Detail Modal -->
    <div id="txn-detail-modal" class="fixed inset-0 z-[9999] flex items-center justify-center hidden opacity-0 transition-opacity duration-300" style="background: rgba(0,0,0,0.75); backdrop-filter: blur(6px);">
        <div class="glass-panel rounded-2xl border border-white/10 p-8 max-w-md w-full mx-4 transform scale-95 transition-transform duration-300" id="txn-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white" data-i18n="dash.txDetails">Transaction Details</h3>
                <button id="close-txn-modal" class="text-gray-400 hover:text-white transition p-1 rounded-lg hover:bg-white/10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="space-y-4" id="txn-modal-body">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Hint -->
    <div id="shortcuts-toast" class="fixed bottom-6 left-6 z-50 glass-panel rounded-xl border border-white/10 px-4 py-3 hidden opacity-0 transition-all duration-300 max-w-xs">
        <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-2">Keyboard Shortcuts</p>
        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-[11px]">
            <span class="text-gray-400"><kbd class="bg-white/10 px-1.5 py-0.5 rounded text-[9px] font-mono">G</kbd> Globe</span>
            <span class="text-gray-400"><kbd class="bg-white/10 px-1.5 py-0.5 rounded text-[9px] font-mono">R</kbd> Reports</span>
            <span class="text-gray-400"><kbd class="bg-white/10 px-1.5 py-0.5 rounded text-[9px] font-mono">D</kbd> Deals</span>
            <span class="text-gray-400"><kbd class="bg-white/10 px-1.5 py-0.5 rounded text-[9px] font-mono">?</kbd> This help</span>
            <span class="text-gray-400"><kbd class="bg-white/10 px-1.5 py-0.5 rounded text-[9px] font-mono">1-5</kbd> Timeframe</span>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        // ── Save mock data as fallback, then clear for live-first UX ──
        (function() {
            if (window.db) {
                window._mockBackup = {
                    registrations: [...window.db.registrations],
                    earnings: [...window.db.earnings],
                    balance: window.db.user ? window.db.user.balance : 0
                };
                window.db.registrations = [];
                window.db.earnings = [];
                if (window.db.user) window.db.user.balance = 0;
            }
        })();
    </script>
    <script>
        // --- Dashboard Logic ---
        let dashboardDatePicker;
        let revenueChart;

        // 1. Initialize Components
        document.addEventListener('DOMContentLoaded', () => {
            // Calculate Month To Date for default
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);

            // Flatpickr
            dashboardDatePicker = flatpickr("#date-range", {
                mode: "range",
                dateFormat: "Y-m-d",
                defaultDate: [firstDay, today],
                theme: "dark",
                monthSelectorType: "static",
                onChange: function(selectedDates, dateStr, instance) {
                    // Reset dropdown to "custom" if user manually picks dates (optional logic, but good UX)
                    // Then update data
                    updateDashboardData();
                }
            });

            // Initialize Chart (Empty initially, will populate on first update)
            initChart();

            // Initial Data Load (Wait for DB)
            setTimeout(() => {
                updateDashboardData();
            }, 200);

            // === MOBILE MENU TOGGLE === (handled by app.js)

            // === BALANCE INFO POPUP TOGGLE ===
            const balanceInfoBtn = document.getElementById('balance-info-btn');
            const balanceInfoPopup = document.getElementById('balance-info-popup');
            if (balanceInfoBtn && balanceInfoPopup) {
                // Move popup to body so it's never clipped by any parent overflow
                document.body.appendChild(balanceInfoPopup);

                function positionBalancePopup() {
                    const rect = balanceInfoBtn.getBoundingClientRect();
                    if (window.innerWidth < 640) {
                        balanceInfoPopup.style.top = (rect.bottom + 8) + 'px';
                        balanceInfoPopup.style.left = '12px';
                        balanceInfoPopup.style.right = '12px';
                        balanceInfoPopup.style.width = 'auto';
                    } else {
                        balanceInfoPopup.style.top = (rect.bottom + 8) + 'px';
                        balanceInfoPopup.style.left = rect.left + 'px';
                        balanceInfoPopup.style.right = '';
                        balanceInfoPopup.style.width = '';
                    }
                }

                function closeBalancePopup() {
                    balanceInfoPopup.classList.add('opacity-0');
                    setTimeout(() => balanceInfoPopup.classList.add('hidden'), 200);
                }

                balanceInfoBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isHidden = balanceInfoPopup.classList.contains('hidden');
                    if (isHidden) {
                        positionBalancePopup();
                        balanceInfoPopup.classList.remove('hidden');
                        requestAnimationFrame(() => balanceInfoPopup.classList.remove('opacity-0'));
                    } else {
                        closeBalancePopup();
                    }
                });
                document.addEventListener('click', (e) => {
                    if (!balanceInfoPopup.contains(e.target) && !balanceInfoBtn.contains(e.target)) {
                        closeBalancePopup();
                    }
                });
                // Close on scroll so popup doesn't detach
                window.addEventListener('scroll', () => {
                    if (!balanceInfoPopup.classList.contains('hidden')) {
                        closeBalancePopup();
                    }
                }, { passive: true });
            }
        });

        // 2. Event Listeners
        
        // Timeframe Dropdown (custom — portal)
        (function() {
            const tfBtn = document.getElementById('timeframe-btn');
            const tfLabel = document.getElementById('timeframe-label');
            const tfPortal = document.getElementById('timeframe-dropdown-portal');
            const tfHidden = document.getElementById('dashboard-timeframe');
            if (!tfBtn || !tfPortal) return;

            const timeframeOpts = [
                { value: 'mtd', label: 'Month to Date' },
                { value: 'today', label: 'Today' },
                { value: 'yesterday', label: 'Yesterday' },
                { value: 'last7', label: 'Last 7 Days' },
                { value: 'last30', label: 'Last 30 Days' },
                { value: 'prev_month', label: 'Previous Month' },
                { value: 'ytd', label: 'Year to Date' },
                { value: 'all', label: 'All Time' }
            ];

            function renderOptions() {
                tfPortal.innerHTML = '<div class="max-h-72 overflow-y-auto py-1">' +
                    timeframeOpts.map(o => `<div class="custom-select-opt px-3 py-2.5 text-sm cursor-pointer hover:bg-white/10 transition text-white${o.value === tfHidden.value ? ' bg-white/5 font-medium' : ''}" data-value="${o.value}">${o.label}</div>`).join('') +
                '</div>';
                tfPortal.querySelectorAll('.custom-select-opt').forEach(opt => {
                    opt.addEventListener('click', () => {
                        tfHidden.value = opt.dataset.value;
                        tfLabel.textContent = opt.textContent;
                        tfPortal.classList.add('hidden');
                        tfBtn.querySelector('svg').classList.remove('rotate-180');
                        tfHidden.dispatchEvent(new Event('change', { bubbles: true }));
                    });
                });
            }

            tfBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const open = !tfPortal.classList.contains('hidden');
                document.querySelectorAll('.custom-select-dd-open').forEach(d => { d.classList.add('hidden'); d.classList.remove('custom-select-dd-open'); });
                if (!open) {
                    const rect = tfBtn.getBoundingClientRect();
                    tfPortal.style.top = (rect.bottom + 4) + 'px';
                    tfPortal.style.left = rect.left + 'px';
                    tfPortal.classList.remove('hidden');
                    tfPortal.classList.add('custom-select-dd-open');
                    tfBtn.querySelector('svg').classList.add('rotate-180');
                    renderOptions();
                } else {
                    tfBtn.querySelector('svg').classList.remove('rotate-180');
                }
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('#timeframe-wrapper') && !e.target.closest('#timeframe-dropdown-portal')) {
                    tfPortal.classList.add('hidden');
                    tfBtn.querySelector('svg').classList.remove('rotate-180');
                }
            });

            // Close dropdown on scroll
            window.addEventListener('scroll', () => {
                if (!tfPortal.classList.contains('hidden')) {
                    tfPortal.classList.add('hidden');
                    tfBtn.querySelector('svg').classList.remove('rotate-180');
                }
            }, true);
        })();

        document.getElementById('dashboard-timeframe').addEventListener('change', function(e) {
            const period = e.target.value;
            const today = new Date();
            let start, end = today;

            switch(period) {
                case 'today':
                    start = today;
                    break;
                case 'yesterday':
                    const y = new Date();
                    y.setDate(today.getDate() - 1);
                    start = y;
                    end = y;
                    break;
                case 'last7':
                    const l7 = new Date();
                    l7.setDate(today.getDate() - 7);
                    start = l7;
                    break;
                case 'last30':
                    const l30 = new Date();
                    l30.setDate(today.getDate() - 30);
                    start = l30;
                    break;
                case 'prev_month':
                    start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    end = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
                case 'mtd':
                    start = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
                case 'ytd':
                    start = new Date(today.getFullYear(), 0, 1);
                    break;
                case 'all': // Mock "All Time" -> 1 year back
                    start = new Date(today.getFullYear() - 1, 0, 1);
                    break;
            }

            dashboardDatePicker.setDate([start, end]);
            updateDashboardData();
        });

        // Update Button
        document.getElementById('update-dashboard-btn').addEventListener('click', () => {
             updateDashboardData();
             showToast("Dashboard updated", "success");
        });

        // 3. Core Update Logic
        window.updateDashboardData = updateDashboardData;
        async function updateDashboardData() {
            const database = window.db || (typeof db !== 'undefined' ? db : null);
            if (!database || !dashboardDatePicker) {
                // Retry if valid DB not found yet
                setTimeout(updateDashboardData, 100);
                return;
            }

            // Get Range
            const dates = dashboardDatePicker.selectedDates;
            const startDate = dates[0] || new Date(0);
            const endDate = dates[1] || new Date();
            endDate.setHours(23, 59, 59, 999);

            // Filter Data
            const filteredEarnings = database.earnings.filter(item => {
                const d = new Date(item.created);
                return d >= startDate && d <= endDate;
            });
            const filteredRegs = database.registrations.filter(item => {
                const d = new Date(item.date);
                return d >= startDate && d <= endDate;
            });

            // Calculate KPIs from live data (these are initial values, overwritten by backend)
            const totalCommission = filteredEarnings.filter(e => e.type === 'Commission').reduce((acc, curr) => acc + (curr.commission_amount || curr.amount || 0), 0);
            const totalRegs = filteredRegs.length;
            const ftDs = filteredEarnings.filter(e => e.type === 'FTD').length;
            // QFTD: only count actual qualified_cpa events (not mock logic)
            const qftDs = filteredEarnings.filter(e => e.type === 'QCPA').length;
            // ROI calculation using real deposit data + formula from backend
            // Sum firstDeposit per unique user from registrations (not per earning event)
            const totalDeposit = filteredRegs.reduce((acc, reg) => acc + (reg.firstDeposit || 0), 0);
            const roiFormula = window._tfxsRoiFormula || "deposit_div_commission";
            const roi = window.calculateROI ? window.calculateROI(roiFormula, totalDeposit, totalCommission) : (totalCommission > 0 ? (totalDeposit / totalCommission).toFixed(2) : "0.00");

            // Update DOM with animated counters
            const commEl = document.getElementById('kpi-commission');
            const regEl = document.getElementById('kpi-registrations');
            const ftdEl = document.getElementById('kpi-ftd');
            const qftdEl = document.getElementById('kpi-qftd');
            const roiEl = document.getElementById('kpi-roi');

            // Remove skeleton class on first load
            [commEl, regEl, ftdEl, qftdEl, roiEl].forEach(el => el.classList.remove('skeleton'));

            // Animated count-up
            animateValue(commEl, 0, totalCommission, 900, v => formatCurrency(v));
            animateValue(regEl, 0, totalRegs, 700);
            animateValue(ftdEl, 0, ftDs, 600);
            animateValue(qftdEl, 0, qftDs, 600);
            animateValue(roiEl, 0, parseFloat(roi), 800, v => v.toFixed(2));

            // Update Chart
            updateChart(filteredEarnings, filteredRegs, startDate, endDate);

            // Update Globe (If available)
            if(window.updateGlobeData) {
                window.updateGlobeData(filteredRegs, filteredEarnings);
            }

            // Update Transactions Table (showing up to 10 from filtered, further filtered by dropdowns)
            updateTransactionsTable(filteredEarnings.slice(0, 10));

            // Update Sidebar Activity Feed (combined timeline)
            updateActivityFeed(filteredRegs, filteredEarnings);

            // Update Sparklines (7-day trailing from DB, not filtered)
            updateSparklines();

            // Update Country Charts
            updateCountryCharts(filteredRegs, filteredEarnings);

            // Populate country filter dropdown (once)
            populateCountryFilter();

            // Populate amount filter dropdown from real data
            populateAmountFilter();

            // === BALANCE CALCULATION (from real API) ===
            const API = window.TFXS_API;
            if (API) {
                try {
                    const affiliateId = API.getAffiliateId();
                    const balRes = await API.fetchPayoutBalance(affiliateId);
                    if (balRes.ok) {
                        const b = balRes.data;
                        const available = b.available || 0;
                        const lifetime = b.total_earned || 0;
                        const paid = b.total_paid || 0;
                        const pending = b.pending || 0;
                        const currentMonth = b.current_month_earnings || 0;
                        const lastMonth = b.last_month_earnings || 0;
                        const isSameMonth = b.same_month === true;

                        // My Balance: dynamic based on schedule type
                        // Same-month: available already includes current month (payable = totalEarned)
                        // Following-month: available = previous months unpaid, so add currentMonth
                        const myBalance = isSameMonth ? available : (available + currentMonth);

                        document.getElementById('balance-display').textContent = formatCurrency(myBalance);
                        document.getElementById('popup-available').textContent = formatCurrency(available);
                        document.getElementById('popup-lifetime').textContent = formatCurrency(lifetime);
                        document.getElementById('popup-paid').textContent = formatCurrency(paid);

                        // Dynamic labels based on schedule mode
                        const accruingRow = document.getElementById('popup-accruing-row');
                        const accruingDivider = document.getElementById('popup-accruing-divider');
                        const accruingEl = document.getElementById('popup-accruing');
                        const availableSub = document.getElementById('popup-available-sub');

                        if (isSameMonth) {
                            // Same-month: show current month in accruing row, available = everything minus paid
                            if (accruingRow) accruingRow.style.display = '';
                            if (accruingDivider) accruingDivider.style.display = '';
                            if (accruingEl) accruingEl.textContent = formatCurrency(currentMonth);
                            const accruingLabel = document.getElementById('popup-accruing-label');
                            if (accruingLabel) accruingLabel.textContent = 'This Month Earned';
                            const accruingSub = document.getElementById('popup-accruing-sub');
                            if (accruingSub) accruingSub.textContent = 'Immediately payable';
                            if (availableSub) availableSub.textContent = 'After withdrawals';
                        } else {
                            // Following-month: show current month accruing
                            if (accruingRow) accruingRow.style.display = '';
                            if (accruingDivider) accruingDivider.style.display = '';
                            if (accruingEl) accruingEl.textContent = formatCurrency(currentMonth);
                            const accruingLabel = document.getElementById('popup-accruing-label');
                            if (accruingLabel) accruingLabel.textContent = 'Current Month';
                            const accruingSub = document.getElementById('popup-accruing-sub');
                            if (accruingSub) accruingSub.textContent = 'Earning this month';
                            if (availableSub) availableSub.textContent = 'Last month (unpaid)';
                        }

                        // Payout draws from 'available' (same-month: includes current; following: previous months only)
                        _payoutAvailable = available;
                        if (b.schedule) _payoutSchedule = b.schedule;
                        window._isSameMonthSchedule = isSameMonth;
                        _hasPendingRequest = b.has_pending_request || false;

                        // Update balance card + payout modal dynamic labels
                        const balCardSub = document.getElementById('balance-card-sub');
                        const modalSubtitle = document.getElementById('payout-modal-subtitle');
                        const modalAvailSub = document.getElementById('payout-available-sub2');
                        if (isSameMonth) {
                            if (modalSubtitle) modalSubtitle.textContent = 'All confirmed commissions';
                            if (modalAvailSub) modalAvailSub.textContent = 'After withdrawals';
                        } else {
                            if (modalSubtitle) modalSubtitle.textContent = 'Commissions from previous month(s)';
                            if (modalAvailSub) modalAvailSub.textContent = 'Last month (unpaid)';
                        }

                        // Store lifetime total for globe modal
                        window._lifetimeEarned = lifetime;

                        // ── Commission KPI shows total_earned from backend (NOT available balance) ──
                        // BUT: when a broker filter is active, keep the broker-filtered value from fetchSummary
                        const activeBrokerFilter = API.getSelectedBroker ? API.getSelectedBroker() : '';
                        if (!activeBrokerFilter) {
                            const commKpi = document.getElementById('kpi-commission');
                            if (commKpi) {
                                animateValue(commKpi, 0, lifetime, 900, v => formatCurrency(v));
                            }
                        }

                        // Next payout date (affiliates only) / Active affiliates count (admins)
                        const isAdmin = localStorage.getItem('is_admin') === 'true';
                        if (isAdmin) {
                            // Admin: show total affiliates count
                            const npLabel = document.getElementById('popup-last-label');
                            if (npLabel) npLabel.textContent = 'Active Affiliates';
                            const npIcon = document.getElementById('popup-last-icon');
                            if (npIcon) npIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>';
                            const npEl = document.getElementById('popup-next-payout');
                            if (npEl) npEl.textContent = b.total_affiliates != null ? b.total_affiliates : '--';
                        } else if (typeof getNextPayoutDate === 'function') {
                            const nextPayoutDate = getNextPayoutDate();
                            document.getElementById('popup-next-payout').textContent = nextPayoutDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                        }

                        // % change: compare current month vs last month
                        const pctChange = lastMonth > 0 ? (((currentMonth - lastMonth) / lastMonth) * 100).toFixed(1) : (currentMonth > 0 ? '100.0' : '0.0');

                        const badge = document.getElementById('balance-change-badge');
                        if (badge) {
                            const isPositive = parseFloat(pctChange) >= 0;
                            const arrowSvg = isPositive
                                ? '<svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7 17l9.2-9.2M17 17V7H7"/></svg>'
                                : '<svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17 7l-9.2 9.2M7 7v10h10"/></svg>';
                            badge.innerHTML = arrowSvg + ' ' + Math.abs(pctChange) + '%';
                            badge.className = isPositive
                                ? 'text-xs font-bold text-green-500 bg-green-500/10 px-1.5 py-0.5 rounded border border-green-500/20 inline-flex items-center gap-0.5'
                                : 'text-xs font-bold text-red-500 bg-red-500/10 px-1.5 py-0.5 rounded border border-red-500/20 inline-flex items-center gap-0.5';
                        }
                    }
                } catch (err) {
                    console.warn('[Dashboard] Could not load balance from API:', err.message);
                }

                // === KYC PAYOUT GATE ===
                const isAdmin = localStorage.getItem('is_admin') === 'true';
                if (!isAdmin) {
                    try {
                        const jwt = localStorage.getItem('tfxs_jwt');
                        const kycRes = await fetch(`${API_BASE}/api/kyc/status`, { headers: { 'Authorization': `Bearer ${jwt}` } });
                        const kycData = await kycRes.json();
                        const kycStatus = kycData.data?.status || 'none';
                        const payBtn = document.getElementById('request-payout-btn');
                        const kycWarn = document.getElementById('kyc-payout-warning');
                        if (kycStatus !== 'approved') {
                            if (payBtn) { payBtn.disabled = true; payBtn.classList.remove('btn-gradient'); payBtn.classList.add('cursor-not-allowed'); payBtn.style.background = 'rgba(127,29,29,0.3)'; payBtn.style.borderColor = 'rgba(153,27,27,0.4)'; payBtn.style.border = '1px solid rgba(153,27,27,0.4)'; payBtn.onclick = null; }
                            if (kycWarn) kycWarn.classList.remove('hidden');
                        } else {
                            if (payBtn) { payBtn.disabled = false; payBtn.classList.add('btn-gradient'); payBtn.classList.remove('cursor-not-allowed'); payBtn.style.background = ''; payBtn.style.border = ''; payBtn.style.borderColor = ''; payBtn.onclick = openPayoutModal; }
                            if (kycWarn) kycWarn.classList.add('hidden');
                        }
                    } catch (e) { console.warn('[KYC] Gate check failed:', e.message); }
                }
            }

        }

        function updateActivityFeed(regs, earnings) {
            const feed = document.getElementById('activity-feed');
            if(!feed) return;
            feed.innerHTML = '';

            const database = window.db;

            // Build a combined timeline from real data
            const events = [];

            // Add registrations
            regs.forEach(r => {
                events.push({
                    type: 'reg',
                    date: new Date(r.date),
                    country: r.country.name,
                    flag: r.country.flag,
                    countryCode: r.country.code,
                    userId: r.userId,
                    amount: 0
                });
            });

            // Add earnings — distinguish FTD vs Commission vs QCPA by event type
            earnings.filter(e => e.type === 'Commission' || e.type === 'FTD' || e.type === 'QCPA').forEach(e => {
                let country = 'Unknown', flag = '🌍', countryCode = '';
                if(database) {
                    const user = database.registrations.find(u => u.userId === e.userId);
                    if(user && user.country) { country = user.country.name; flag = user.country.flag; countryCode = user.country.code; }
                }
                // QCPA is a KPI status event (no money), Commission is money, FTD is deposit
                const evType = e.type === 'Commission' ? 'comm' : (e.type === 'FTD' ? 'ftd' : (e.type === 'QCPA' ? 'qcpa' : null));
                if (!evType) return;
                events.push({
                    type: evType,
                    date: new Date(e.created),
                    country: country,
                    flag: flag,
                    countryCode: countryCode,
                    userId: e.userId,
                    amount: e.type === 'Commission' ? (e.commission_amount || e.amount || 0) : (e.type === 'FTD' ? (e.deposit_amount || e.amount || 0) : 0)
                });
            });

            // Sort most recent first, take top 6
            events.sort((a, b) => b.date - a.date);
            const top = events.slice(0, 5);

            if(top.length === 0) {
                feed.innerHTML = '<li class="text-xs text-gray-500 text-center py-4">No activity for this period</li>';
                return;
            }

            const now = new Date();

            top.forEach(ev => {
                const li = document.createElement('li');
                li.className = 'flex gap-3 items-start';

                const isComm = ev.type === 'comm';
                const isFtd = ev.type === 'ftd';
                const isQcpa = ev.type === 'qcpa';
                const dotColor = isComm ? 'bg-brand-500 shadow-[0_0_8px_#ef4444]'
                    : isFtd ? 'bg-green-500 shadow-[0_0_8px_#22c55e]'
                    : isQcpa ? 'bg-amber-500 shadow-[0_0_8px_#f59e0b]'
                    : 'bg-blue-500 shadow-[0_0_8px_#3b82f6]';
                const title = isComm ? `New Commission (${ev.country})`
                    : isFtd ? `New FTD (${ev.country})`
                    : isQcpa ? `Qualified CPA (${ev.country})`
                    : `Registration (${ev.country})`;
                const fHTML = ev.flag || '🌍';
                const desc = isComm
                    ? `${fHTML} Conversion from ${ev.userId}, payout: $${ev.amount.toFixed(2)}`
                    : isFtd
                    ? `${fHTML} Deposit from ${ev.userId}, amount: $${ev.amount.toFixed(2)}`
                    : isQcpa
                    ? `${fHTML} ${ev.userId} qualified`
                    : `${fHTML} New signup: ${ev.userId}`;
                // Extra badge for Commission (+250$) and QCPA (+1 QFTD)
                const extraBadge = isComm ? `+${Math.round(ev.amount)}$`
                    : isQcpa ? '+1 QFTD'
                    : null;

                // Time ago
                const diffMs = now - ev.date;
                const diffMin = Math.floor(diffMs / 60000);
                const diffHr = Math.floor(diffMin / 60);
                const diffDay = Math.floor(diffHr / 24);
                let ago;
                if(diffMin < 1) ago = 'just now';
                else if(diffMin < 60) ago = `${diffMin} min ago`;
                else if(diffHr < 24) ago = `${diffHr}h ago`;
                else ago = `${diffDay}d ago`;

                li.innerHTML = `
                    <div class="w-1.5 h-1.5 rounded-full ${dotColor} mt-1.5 flex-shrink-0"></div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center gap-2">
                            <h3 class="text-xs font-bold text-white truncate">${title}</h3>
                            <span class="text-[10px] font-mono text-gray-500 whitespace-nowrap">${ago}</span>
                        </div>
                        <p class="text-[10px] text-gray-400 font-light mt-0.5 truncate">${desc}</p>
                        ${extraBadge ? `<p class="text-[10px] text-brand-500 font-medium mt-0.5">${extraBadge}</p>` : ''}
                    </div>
                `;
                feed.appendChild(li);
            });
        }

        // ── Highcharts Theming ──
        let _lastUpdateTs  = 0;
        const UPDATE_THROTTLE_MS = 2000;
        let _pendingUpdate = null;

        // ── Downsample helper (keeps first + last, every Nth) ──
        function _downsample(labels, commData, regData, maxPts) {
            const len = labels.length;
            if (len <= maxPts) return { labels, commData, regData };
            const step = Math.ceil(len / maxPts);
            const l = [], c = [], r = [];
            for (let i = 0; i < len; i++) {
                if (i === 0 || i === len - 1 || i % step === 0) {
                    l.push(labels[i]); c.push(commData[i]); r.push(regData[i]);
                }
            }
            return { labels: l, commData: c, regData: r };
        }

        function _smartRegTick(maxReg) {
            if (maxReg <= 0) return { interval: 1, max: 2 };
            if (maxReg <= 5) return { interval: 1, max: maxReg + 1 };
            if (maxReg <= 10) return { interval: 1, max: maxReg + 1 };
            if (maxReg <= 20) return { interval: 2, max: Math.ceil(maxReg / 2) * 2 + 2 };
            if (maxReg <= 50) return { interval: 5, max: Math.ceil(maxReg / 5) * 5 + 5 };
            if (maxReg <= 100) return { interval: 10, max: Math.ceil(maxReg / 10) * 10 + 10 };
            const mag = Math.pow(10, Math.floor(Math.log10(maxReg)));
            const interval = Math.ceil(maxReg / mag) > 5 ? mag : mag / 2;
            return { interval, max: Math.ceil(maxReg / interval) * interval + interval };
        }

        function updateChart(earnings, regs, startDate, endDate) {
            // ── Bucket calculation ──
            const msPerDay = 86400000;
            const daySpan = Math.ceil((endDate - startDate) / msPerDay);
            const buckets = {};
            let curr = new Date(startDate); curr.setHours(0,0,0,0);
            const end = new Date(endDate); end.setHours(23,59,59,999);
            const groupByWeek = daySpan > 45;

            function getBucketKey(d) {
                if (groupByWeek) {
                    const dt = new Date(d); const day = dt.getDay();
                    dt.setDate(dt.getDate() - day + (day === 0 ? -6 : 1));
                    return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
                }
                return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            }
            function getBucketLabel(d) {
                if (groupByWeek) {
                    const dt = new Date(d); const day = dt.getDay();
                    dt.setDate(dt.getDate() - day + (day === 0 ? -6 : 1));
                    return dt.toLocaleDateString('en-US', { day: '2-digit', month: 'short' });
                }
                return d.toLocaleDateString('en-US', { day: '2-digit', month: 'short' });
            }

            let safety = 0;
            while (curr <= end && safety < 500) {
                const key = getBucketKey(curr);
                if (!buckets[key]) buckets[key] = { label: getBucketLabel(curr), comm: 0, reg: 0 };
                curr.setDate(curr.getDate() + 1); safety++;
            }
            // Only count Commission/QCPA events for the commission line (not FTD deposits)
            earnings.filter(e => e.type === 'Commission' || e.type === 'QCPA').forEach(e => { const k = getBucketKey(new Date(e.created)); if (buckets[k]) buckets[k].comm += (e.commission_amount || e.amount || 0); });
            regs.forEach(r => { const k = getBucketKey(new Date(r.date)); if (buckets[k]) buckets[k].reg += 1; });

            let labels   = Object.values(buckets).map(d => d.label);
            let commData = Object.values(buckets).map(d => d.comm);
            let regData  = Object.values(buckets).map(d => d.reg);

            // Downsample if too many points
            if (labels.length > 120) {
                const ds = _downsample(labels, commData, regData, 120);
                labels = ds.labels; commData = ds.commData; regData = ds.regData;
            }

            // ── Throttle guard ──
            const now = Date.now();
            const doUpdate = () => {
                if (!revenueChart) return;
                const maxReg = Math.max(...regData, 0);
                const regTick = _smartRegTick(maxReg);
                revenueChart.xAxis[0].setCategories(labels, false);
                revenueChart.series[0].setData(commData, true);
                revenueChart.series[1].setData(regData, true);
                revenueChart.yAxis[1].update({ tickInterval: regTick.interval, max: regTick.max, tickAmount: 5 }, false);
                revenueChart.redraw(true);
                _lastUpdateTs = Date.now();
            };

            if (now - _lastUpdateTs >= UPDATE_THROTTLE_MS) {
                if (_pendingUpdate) { clearTimeout(_pendingUpdate); _pendingUpdate = null; }
                requestAnimationFrame(doUpdate);
            } else {
                if (_pendingUpdate) clearTimeout(_pendingUpdate);
                _pendingUpdate = setTimeout(() => {
                    _pendingUpdate = null;
                    requestAnimationFrame(doUpdate);
                }, UPDATE_THROTTLE_MS - (now - _lastUpdateTs));
            }
        }

        function initChart() {
            const container = document.getElementById('revenueChartContainer');
            if (!container) return;

            // Highcharts global dark theme
            Highcharts.setOptions({
                chart: { style: { fontFamily: 'JetBrains Mono, Inter, system-ui, sans-serif' } },
                credits: { enabled: false },
                exporting: { enabled: false }
            });

            revenueChart = Highcharts.chart(container, {
                chart: {
                    type: 'areaspline',
                    height: 380,
                    backgroundColor: 'transparent',
                    spacing: window.innerWidth < 640 ? [8, 4, 6, 4] : [24, 8, 24, 8],
                    animation: { duration: 600, easing: 'easeOutCubic' },
                    reflow: true,
                    zooming: { type: 'x' },
                    resetZoomButton: {
                        theme: {
                            fill: 'rgba(255,255,255,0.08)',
                            stroke: 'rgba(255,255,255,0.15)',
                            style: { color: '#a1a1aa', fontSize: '10px', fontFamily: 'JetBrains Mono, monospace' },
                            r: 6,
                            states: { hover: { fill: 'rgba(255,255,255,0.15)' } }
                        },
                        position: { align: 'right', y: -4 }
                    }
                },
                title: { text: null },
                legend: { enabled: false },
                xAxis: {
                    categories: [],
                    crosshair: {
                        width: 1,
                        color: 'rgba(255,255,255,0.15)',
                        dashStyle: 'ShortDash'
                    },
                    labels: {
                        style: { color: '#71717a', fontSize: window.innerWidth < 640 ? '8px' : '10px', fontFamily: 'JetBrains Mono, monospace' },
                        rotation: window.innerWidth < 640 ? -45 : 0,
                        step: window.innerWidth < 480 ? 2 : (window.innerWidth < 640 ? 1 : 0),
                        overflow: 'allow',
                        allowOverlap: false,
                        reserveSpace: true,
                        y: window.innerWidth >= 1024 ? 18 : undefined
                    },
                    lineColor: 'rgba(255,255,255,0.06)',
                    lineWidth: 1,
                    tickLength: 0,
                    gridLineWidth: 0
                },
                yAxis: [
                    { // Left axis — Commission
                        title: {
                            text: 'Commission ($)',
                            style: { color: 'rgba(229,57,53,0.7)', fontSize: '10px', fontWeight: '600', fontFamily: 'JetBrains Mono, monospace' }
                        },
                        labels: {
                            style: { color: 'rgba(229,57,53,0.65)', fontSize: '10px', fontFamily: 'JetBrains Mono, monospace' },
                            formatter: function() {
                                if (this.value >= 1000) return '$' + (this.value / 1000).toFixed(1) + 'K';
                                return '$' + Math.round(this.value);
                            }
                        },
                        min: 0,
                        tickAmount: 5,
                        gridLineColor: 'rgba(255,255,255,0.04)',
                        gridLineDashStyle: 'Dot',
                        gridLineWidth: 1,
                        lineWidth: 0,
                        tickWidth: 0,
                        opposite: false
                    },
                    { // Right axis — Registrations
                        title: {
                            text: 'Registrations',
                            style: { color: 'rgba(251,192,45,0.7)', fontSize: '10px', fontWeight: '600', fontFamily: 'JetBrains Mono, monospace' }
                        },
                        labels: {
                            style: { color: 'rgba(251,192,45,0.65)', fontSize: '10px', fontFamily: 'JetBrains Mono, monospace' },
                            formatter: function() { return Math.round(this.value); }
                        },
                        min: 0,
                        allowDecimals: false,
                        tickAmount: 5,
                        gridLineWidth: 0,
                        lineWidth: 0,
                        tickWidth: 0,
                        opposite: true
                    }
                ],
                tooltip: {
                    shared: true,
                    useHTML: true,
                    backgroundColor: 'transparent',
                    borderWidth: 0,
                    shadow: false,
                    style: { padding: '0' },
                    formatter: function() {
                        const isLt = document.documentElement.classList.contains('light-theme');
                        const bg = isLt ? 'rgba(255,255,255,0.96)' : 'rgba(15,15,20,0.94)';
                        const border = isLt ? 'rgba(0,0,0,0.10)' : 'rgba(255,255,255,0.08)';
                        const shadow = isLt ? '0 4px 20px rgba(0,0,0,0.18), 0 0 0 1px rgba(0,0,0,0.05)' : '0 4px 12px rgba(0,0,0,0.4)';
                        const headerColor = isLt ? '#6b7280' : '#a1a1aa';
                        const valColor = isLt ? '#1d1d1f' : '#fff';
                        const lblColor = isLt ? '#6b7280' : '#a1a1aa';

                        let html = '<div style="background:' + bg + ';border:1px solid ' + border + ';border-radius:8px;padding:8px 12px;box-shadow:' + shadow + ';font-family:JetBrains Mono,monospace;font-size:11px;">';
                        html += '<span style="font-size:10px;color:' + headerColor + ';font-weight:500;">' + this.x + '</span><br/>';
                        for (let i = 0; i < this.points.length; i++) {
                            const p = this.points[i];
                            const dot = '<span style="color:' + p.series.color + ';">●</span> ';
                            if (p.series.index === 0) {
                                html += dot + '<span style="color:' + lblColor + ';">Commission</span>  <b style="color:' + valColor + ';">$' + Number(p.y).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + '</b><br/>';
                            } else {
                                html += dot + '<span style="color:' + lblColor + ';">Registrations</span>  <b style="color:' + valColor + ';">' + Math.round(p.y) + '</b><br/>';
                            }
                        }
                        html += '</div>';
                        return html;
                    }
                },
                plotOptions: {
                    areaspline: {
                        lineWidth: 2,
                        marker: { enabled: false, symbol: 'circle', radius: 3, states: { hover: { enabled: true, radius: 4, lineWidth: 2, lineColor: document.documentElement.classList.contains('light-theme') ? '#1d1d1f' : '#fff' } } },
                        states: { hover: { lineWidthPlus: 0 }, inactive: { opacity: 0.5 } },
                        threshold: null
                    },
                    series: {
                        animation: { duration: 600 },
                        turboThreshold: 5000
                    }
                },
                series: [
                    {
                        name: 'Commission',
                        data: [],
                        yAxis: 0,
                        zIndex: 2,
                        color: '#E53935',
                        fillColor: {
                            linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                            stops: [
                                [0, 'rgba(229,57,53,0.25)'],
                                [0.7, 'rgba(229,57,53,0.06)'],
                                [1, 'rgba(229,57,53,0.0)']
                            ]
                        }
                    },
                    {
                        name: 'Registrations',
                        data: [],
                        yAxis: 1,
                        zIndex: 1,
                        color: '#FBC02D',
                        fillColor: {
                            linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                            stops: [
                                [0, 'rgba(251,192,45,0.25)'],
                                [0.7, 'rgba(251,192,45,0.06)'],
                                [1, 'rgba(251,192,45,0.0)']
                            ]
                        }
                    }
                ]
            });

            // Handle chart resize for label rotation
            const resizeHandler = () => {
                if (!revenueChart) return;
                const w = revenueChart.chartWidth;
                revenueChart.xAxis[0].update({
                    labels: {
                        rotation: w < 500 ? -45 : 0,
                        step: w < 400 ? 2 : (w < 500 ? 1 : 0),
                        style: { fontSize: w < 500 ? '8px' : '10px' }
                    }
                }, false);
                revenueChart.redraw(false);
            };
            // Debounced resize
            let chartResizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(chartResizeTimer);
                chartResizeTimer = setTimeout(resizeHandler, 250);
            });

            // ResizeObserver: reflow chart when container dimensions change
            const chartArea = document.getElementById('chartArea');
            if (chartArea && typeof ResizeObserver !== 'undefined') {
                let roTimer;
                new ResizeObserver(() => {
                    clearTimeout(roTimer);
                    roTimer = setTimeout(() => { if (revenueChart) { revenueChart.reflow(); resizeHandler(); } }, 100);
                }).observe(chartArea);
            }
        }

        function toggleChartSeries(datasetIndex) {
            if (!revenueChart || !revenueChart.series || !revenueChart.series[datasetIndex]) return;
            const series = revenueChart.series[datasetIndex];
            if (series.visible) { series.hide(); } else { series.show(); }
            const btn = document.querySelector(`.chart-legend-item[data-index="${datasetIndex}"]`);
            if (btn) {
                btn.classList.toggle('opacity-40', !series.visible);
                btn.classList.toggle('opacity-100', series.visible);
            }
        }

        function updateTransactionsTable(earnings) {
             const tbody = document.getElementById('transactions-tbody');
             if(!tbody) return;
             
             tbody.innerHTML = '';
             
             // Apply filters
             const countryFilter = document.getElementById('txn-country-filter')?.value || '';
             const amountFilter = document.getElementById('txn-amount-filter')?.value || '';
             
             const database = window.db;
             let filtered = earnings;
             
             if (countryFilter || amountFilter) {
                 filtered = earnings.filter(tx => {
                     let pass = true;
                     if (database && countryFilter) {
                         const user = database.registrations.find(u => u.userId === tx.userId);
                         if (!user || !user.country || user.country.name !== countryFilter) pass = false;
                     }
                     if (amountFilter && tx.amount !== parseFloat(amountFilter)) pass = false;
                     return pass;
                 });
             }
             
             const isAdminView = localStorage.getItem('is_admin') === 'true';
             const colSpan = isAdminView ? 7 : 6;

             if(filtered.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="${colSpan}" class="text-center py-4 text-gray-500">No transactions for this period</td></tr>`;
                 return;
             }

             filtered.forEach(tx => {
                 const tr = document.createElement('tr');
                 tr.className = "hover:bg-white/5 transition-colors group cursor-pointer";
                 
                 // Real Data Lookup
                 let countryName = 'Unknown';
                 let countryFlag = '🏳️';
                 let countryCode = '';
                 
                 if(database) {
                      const user = database.registrations.find(u => u.userId === tx.userId);
                      if(user && user.country) {
                          countryName = user.country.name;
                          countryFlag = user.country.flag || '🌍';
                          countryCode = user.country.code || '';
                      }
                 }
                 
                 // Amount column logic:
                 // - FTD: show deposit amount
                 // - Commission/QCPA: show commission amount
                 // - Registration: show $0.00
                 let displayAmount = 0;
                 if (tx.type === "FTD") {
                     displayAmount = tx.deposit_amount || tx.amount || 0;
                 } else if (tx.type === "Commission" || tx.type === "QCPA") {
                     displayAmount = tx.commission_amount || tx.amount || 0;
                 }

                 const rawStatus = tx.status || "pending";
                 const statusConfig = {
                     paid: { class: "bg-green-500/10 text-green-400 border-green-500/20", text: "Paid" },
                     approved: { class: "bg-blue-500/10 text-blue-400 border-blue-500/20", text: "Approved" },
                     pending: { class: "bg-yellow-500/10 text-yellow-400 border-yellow-500/20", text: "Pending" },
                     rejected: { class: "bg-red-500/10 text-red-400 border-red-500/20", text: "Rejected" }
                 };
                 const st = statusConfig[rawStatus] || statusConfig.pending;

                 const affCol = isAdminView ? `<td class="px-6 py-4 text-xs font-mono text-brand-500">${tx.afp || tx.affiliate_code || '—'}</td>` : '';
                 const txFlagHTML = `<span class="text-sm">${countryFlag}</span>`;

                 tr.innerHTML = `
                    ${affCol}
                    <td class="px-6 py-4 text-gray-300 font-medium group-hover:text-white transition-colors text-xs">${tx.userId}</td>
                    <td class="px-6 py-4 text-gray-500 text-[10px] uppercase font-mono">${new Date(tx.created).toLocaleDateString()} ${new Date(tx.created).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                    <td class="px-6 py-4 font-bold text-white text-xs">${tx.type}</td>
                    <td class="px-6 py-4 text-gray-400 text-xs">
                         <span class="inline-flex items-center gap-1.5">${txFlagHTML} ${countryName}</span>
                    </td>
                    <td class="px-6 py-4 font-bold text-white text-right text-xs">$${displayAmount.toFixed(2)}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="px-2 py-1 rounded ${st.class} border text-[10px] font-bold uppercase">${st.text}</span>
                    </td>
                 `;
                 
                 // Click to open detail modal
                 tr.addEventListener('click', () => openTxnModal(tx));
                 
                 tbody.appendChild(tr);
             });
        }
        
        // ── Quick Share — Dynamic Broker Links from Deals API ──
        (function() {
            const brokerHidden = document.getElementById('broker-select');
            const brokerBtn = document.getElementById('broker-select-btn');
            const brokerLabel = document.getElementById('broker-select-label');
            const brokerDropdown = document.getElementById('broker-select-dropdown');
            const brokerOptions = document.getElementById('broker-select-options');
            const linkDisplay = document.getElementById('affiliate-link');
            const copyBtn = document.getElementById('copy-link-btn');
            const qrBtn = document.getElementById('qr-btn');
            let dealLinks = [];

            function resolveLink(template, afp) {
                if (!template || !afp) return template || '';
                return template
                    .replace(/\{AFP\}/gi, afp)
                    .replace(/\[afp\]/gi, afp)
                    .replace(/\{afp\}/gi, afp)
                    .replace(/=AFP$/i, '=' + afp)
                    .replace(/=AFP&/i, '=' + afp + '&');
            }

            function renderBrokerOptions() {
                brokerOptions.innerHTML = dealLinks.map((d, i) =>
                    `<div class="custom-select-opt px-3 py-2.5 text-sm cursor-pointer hover:bg-white/10 transition text-white${i === parseInt(brokerHidden.value) ? ' bg-white/5 text-brand-500 font-medium' : ''}" data-value="${i}">${d.broker}</div>`
                ).join('');
                brokerOptions.querySelectorAll('.custom-select-opt').forEach(opt => {
                    opt.addEventListener('click', () => {
                        const idx = parseInt(opt.dataset.value);
                        brokerHidden.value = idx;
                        brokerLabel.textContent = dealLinks[idx].broker;
                        brokerDropdown.classList.add('hidden');
                        brokerBtn.querySelector('svg').classList.remove('rotate-180');
                        updateLink(idx);
                    });
                });
            }

            brokerBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const open = !brokerDropdown.classList.contains('hidden');
                document.querySelectorAll('.custom-select-dd-open').forEach(d => { d.classList.add('hidden'); d.classList.remove('custom-select-dd-open'); });
                if (!open) {
                    // Position dropdown using fixed coordinates to escape stacking contexts
                    const rect = brokerBtn.getBoundingClientRect();
                    brokerDropdown.style.top = (rect.bottom + 4) + 'px';
                    brokerDropdown.style.left = rect.left + 'px';
                    brokerDropdown.style.width = Math.max(rect.width, 180) + 'px';
                    brokerDropdown.classList.remove('hidden');
                    brokerDropdown.classList.add('custom-select-dd-open');
                    brokerBtn.querySelector('svg').classList.add('rotate-180');
                    renderBrokerOptions();
                } else {
                    brokerBtn.querySelector('svg').classList.remove('rotate-180');
                }
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('#broker-select-wrapper') && !e.target.closest('#broker-select-dropdown')) {
                    brokerDropdown.classList.add('hidden');
                    brokerBtn.querySelector('svg').classList.remove('rotate-180');
                }
            });

            // Close dropdown on scroll so it doesn't float away from the button
            window.addEventListener('scroll', () => {
                if (!brokerDropdown.classList.contains('hidden')) {
                    brokerDropdown.classList.add('hidden');
                    brokerBtn.querySelector('svg').classList.remove('rotate-180');
                }
            }, true);

            async function loadBrokerLinks() {
                try {
                    const { fetchDeals, getAffiliateId } = window.TFXS_API || {};
                    if (!fetchDeals) return;
                    const aid = getAffiliateId ? getAffiliateId() : null;
                    const afp = aid || localStorage.getItem('affiliate_id') || '';
                    const res = await fetchDeals(aid);
                    if (!res || !res.ok) return;
                    const deals = res.data || [];
                    const seen = new Set();
                    dealLinks = [];
                    deals.forEach(d => {
                        if (d.broker_link && !seen.has(d.broker)) {
                            seen.add(d.broker);
                            const resolved = resolveLink(d.broker_link, afp);
                            dealLinks.push({ broker: d.broker, link: resolved, title: d.title || d.broker });
                        }
                    });
                    if (!dealLinks.length) {
                        brokerLabel.textContent = 'No broker links available';
                        linkDisplay.textContent = 'No links configured — ask admin to set broker links';
                        return;
                    }
                    brokerHidden.value = '0';
                    brokerLabel.textContent = dealLinks[0].broker;
                    updateLink(0);
                } catch (e) {
                    console.warn('[Quick Share] Could not load broker links:', e.message);
                }
            }

            function updateLink(idx) {
                const deal = dealLinks[idx];
                if (!deal) return;
                const url = deal.link;
                try {
                    const u = new URL(url);
                    const brand = u.searchParams.get('brand') || '';
                    linkDisplay.textContent = brand ? `${u.hostname}/...${brand}` : url;
                } catch (_) {
                    linkDisplay.textContent = url.length > 40 ? url.substring(0, 37) + '...' : url;
                }
                linkDisplay.title = url;
                if (copyBtn) copyBtn.setAttribute('data-copy', url);
            }

            // Copy button
            if (copyBtn) {
                copyBtn.addEventListener('click', () => {
                    const link = copyBtn.getAttribute('data-copy');
                    if (!link) return;
                    navigator.clipboard.writeText(link).then(() => {
                        const orig = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied!';
                        copyBtn.classList.add('border-green-500/30', 'text-green-400');
                        setTimeout(() => {
                            copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg> Copy';
                            copyBtn.classList.remove('border-green-500/30', 'text-green-400');
                        }, 2000);
                    });
                });
            }

            // QR Code button
            if (qrBtn) {
                qrBtn.addEventListener('click', () => {
                    const idx = parseInt(brokerHidden.value) || 0;
                    const deal = dealLinks[idx];
                    if (!deal || !deal.link) return;
                    showQRCode(deal.link, deal.broker);
                });
            }

            // Wait for API to be ready then load
            if (window.TFXS_API) {
                loadBrokerLinks();
            } else {
                document.addEventListener('DOMContentLoaded', () => setTimeout(loadBrokerLinks, 500));
            }
        })();

        // ── Contact Admin Button ──
        (function() {
            const contactRow = document.getElementById('contact-admin-row');
            const contactBtn = document.getElementById('contact-admin-btn');
            const contactDD = document.getElementById('contact-admin-dropdown');
            const emailLink = document.getElementById('contact-email-link');
            const telegramLink = document.getElementById('contact-telegram-link');
            const emailDisplay = document.getElementById('contact-email-display');
            const telegramDisplay = document.getElementById('contact-telegram-display');
            if (!contactRow || !contactBtn || !contactDD) return;

            // Toggle dropdown
            contactBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                contactDD.classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#contact-admin-wrap')) contactDD.classList.add('hidden');
            });

            // Fetch contact info from backend
            async function loadContactInfo() {
                try {
                    const apiGet = window.TFXS_API?.apiGet;
                    if (!apiGet) return;
                    const res = await apiGet('/api/contact-info');
                    if (!res) return;
                    const email = res.contact_email || '';
                    const telegram = (res.contact_telegram || '').replace(/^@/, '');
                    // Only show if at least one is set
                    if (!email && !telegram) return;
                    contactRow.classList.remove('hidden');
                    if (email) {
                        emailLink.href = 'mailto:' + email;
                        emailDisplay.textContent = email;
                        emailLink.classList.remove('hidden');
                    } else {
                        emailLink.classList.add('hidden');
                    }
                    if (telegram) {
                        telegramLink.href = 'https://t.me/' + telegram;
                        telegramDisplay.textContent = '@' + telegram;
                        telegramLink.classList.remove('hidden');
                    } else {
                        telegramLink.classList.add('hidden');
                    }
                } catch (_) {}
            }

            if (window.TFXS_API) {
                loadContactInfo();
            } else {
                // api.js loads at bottom — poll until ready
                const _ci = setInterval(() => { if (window.TFXS_API) { clearInterval(_ci); loadContactInfo(); } }, 300);
                setTimeout(() => clearInterval(_ci), 10000);
            }
        })();

        // ── QR Code Generator ──
        function showQRCode(url, brokerName) {
            const modal = document.getElementById('qr-modal');
            const container = document.getElementById('qr-canvas');
            const nameEl = document.getElementById('qr-broker-name');
            const linkEl = document.getElementById('qr-link-text');
            if (!modal || !container) return;

            nameEl.textContent = brokerName || 'Broker Link';
            linkEl.textContent = url;

            // Generate QR using qrcode-generator lib
            const qr = qrcode(0, 'M');
            qr.addData(url);
            qr.make();

            // Render to high-res canvas
            const modules = qr.getModuleCount();
            const scale = 6; // px per module — crisp at any size
            const padding = scale * 2;
            const size = modules * scale + padding * 2;
            const cvs = document.createElement('canvas');
            cvs.width = size;
            cvs.height = size;
            const ctx = cvs.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, size, size);
            ctx.fillStyle = '#000000';
            for (let r = 0; r < modules; r++) {
                for (let c = 0; c < modules; c++) {
                    if (qr.isDark(r, c)) {
                        ctx.fillRect(padding + c * scale, padding + r * scale, scale, scale);
                    }
                }
            }
            container.innerHTML = '';
            cvs.style.width = '100%';
            cvs.style.height = '100%';
            cvs.style.imageRendering = 'pixelated';
            cvs.style.borderRadius = '8px';
            cvs.id = 'qr-canvas-el';
            container.appendChild(cvs);

            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeQRModal() {
            const modal = document.getElementById('qr-modal');
            if (modal) modal.style.display = 'none';
            document.body.style.overflow = '';
        }

        // ESC key closes QR modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeQRModal();
        });

        function downloadQR() {
            const cvs = document.getElementById('qr-canvas-el');
            if (!cvs) return;
            const a = document.createElement('a');
            a.download = 'tfxs-broker-qr.png';
            a.href = cvs.toDataURL('image/png');
            a.click();
        }
        
        // Server Time Clock
        function updateServerTime() {
            const timeElement = document.getElementById('server-time');
            if (!timeElement) return;
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const offset = -now.getTimezoneOffset() / 60;
            const sign = offset >= 0 ? '+' : '-';
            timeElement.textContent = `${timeString} UTC${sign}${Math.abs(offset)}`;
        }
        updateServerTime();
        setInterval(updateServerTime, 1000);

        // === ANIMATED KPI COUNTER ===
        function animateValue(el, start, end, duration, formatter) {
            let startTs = null;
            const step = (ts) => {
                if (!startTs) startTs = ts;
                const progress = Math.min((ts - startTs) / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 3); // cubic ease-out
                const current = start + (end - start) * ease;
                el.textContent = formatter ? formatter(current) : Math.round(current);
                if (progress < 1) requestAnimationFrame(step);
            };
            requestAnimationFrame(step);
        }

        // === MINI SPARKLINES ===
        function generateSparkline(containerId, data, color) {
            const container = document.getElementById(containerId);
            if (!container || data.length < 2) { if(container) container.innerHTML = ''; return; }

            const w = 120, h = 24;
            const max = Math.max(...data, 1);
            const min = Math.min(...data, 0);
            const range = max - min || 1;
            const points = data.map((v, i) => {
                const x = (i / (data.length - 1)) * w;
                const y = h - ((v - min) / range) * (h - 4) - 2;
                return `${x},${y}`;
            });
            const polyline = points.join(' ');
            // Fill area
            const fillPoints = `0,${h} ${polyline} ${w},${h}`;

            container.innerHTML = `<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
                <defs><linearGradient id="sg-${containerId}" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0%" stop-color="${color}" stop-opacity="0.3"/>
                    <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
                </linearGradient></defs>
                <polygon points="${fillPoints}" fill="url(#sg-${containerId})"/>
                <polyline points="${polyline}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;
        }

        function updateSparklines() {
            const database = window.db;
            if (!database) return;

            const now = new Date();
            const days = 7;
            const dailyComm = Array(days).fill(0);
            const dailyReg = Array(days).fill(0);
            const dailyFtd = Array(days).fill(0);
            const dailyQftd = Array(days).fill(0);
            const dailyDeposit = Array(days).fill(0);

            for (let i = 0; i < days; i++) {
                const dayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - (days - 1 - i));
                const dayEnd = new Date(dayStart);
                dayEnd.setHours(23, 59, 59, 999);

                database.earnings.forEach(e => {
                    const d = new Date(e.created);
                    if (d >= dayStart && d <= dayEnd) dailyComm[i] += e.amount;
                });
                database.registrations.forEach(r => {
                    const d = new Date(r.date);
                    if (d >= dayStart && d <= dayEnd) {
                        dailyReg[i]++;
                        if (r.firstDeposit > 0) dailyFtd[i]++;
                        if (r.firstDeposit > 200) dailyQftd[i]++;
                        dailyDeposit[i] += r.firstDeposit || 0;
                    }
                });
            }

            generateSparkline('sparkline-commission', dailyComm, '#ef4444');
            generateSparkline('sparkline-registrations', dailyReg, '#fbbf24');
            generateSparkline('sparkline-ftd', dailyFtd, '#3b82f6');
            generateSparkline('sparkline-qftd', dailyQftd, '#22c55e');
            // ROI sparkline using real deposit data + formula
            const calcROI = window.calculateROI || ((f, d, c) => c > 0 ? (d / c).toFixed(2) : 0);
            const roiF = window._tfxsRoiFormula || "deposit_div_commission";
            generateSparkline('sparkline-roi', dailyComm.map((c, i) => parseFloat(calcROI(roiF, dailyDeposit[i], c)) || 0), '#a855f7');
        }

        // === COUNTRY DISTRIBUTION CHARTS (Region Drill-Down) ===
        let countryDonutInstance = null;
        let countryBarInstance = null;
        let currentDonutView = 'regions'; // 'regions' | regionKey
        let cachedRegs = [];
        let cachedEarnings = [];

        // Region mapping: ISO code → region
        const REGION_MAP = {
            // Europe
            'DE': 'Europe', 'GB': 'Europe', 'FR': 'Europe', 'IT': 'Europe', 'ES': 'Europe',
            'NL': 'Europe', 'BE': 'Europe', 'PT': 'Europe', 'SE': 'Europe', 'NO': 'Europe',
            'DK': 'Europe', 'FI': 'Europe', 'PL': 'Europe', 'AT': 'Europe', 'CH': 'Europe',
            'IE': 'Europe', 'CZ': 'Europe', 'RO': 'Europe', 'GR': 'Europe', 'HU': 'Europe',
            // Americas
            'US': 'Americas', 'CA': 'Americas', 'BR': 'Americas', 'MX': 'Americas',
            'AR': 'Americas', 'CL': 'Americas', 'CO': 'Americas', 'PE': 'Americas',
            // Asia-Pacific
            'JP': 'Asia-Pacific', 'AU': 'Asia-Pacific', 'NZ': 'Asia-Pacific',
            'KR': 'Asia-Pacific', 'SG': 'Asia-Pacific', 'IN': 'Asia-Pacific',
            'CN': 'Asia-Pacific', 'TH': 'Asia-Pacific', 'MY': 'Asia-Pacific',
            'ID': 'Asia-Pacific', 'PH': 'Asia-Pacific', 'VN': 'Asia-Pacific',
            'HK': 'Asia-Pacific', 'TW': 'Asia-Pacific',
            // Middle East
            'AE': 'Middle East', 'SA': 'Middle East', 'QA': 'Middle East',
            'KW': 'Middle East', 'BH': 'Middle East', 'OM': 'Middle East',
            'IL': 'Middle East', 'TR': 'Middle East', 'LB': 'Middle East',
            // Africa
            'ZA': 'Africa', 'NG': 'Africa', 'KE': 'Africa', 'EG': 'Africa',
            'GH': 'Africa', 'MA': 'Africa', 'TN': 'Africa', 'TZ': 'Africa',
            'TG': 'Africa', 'SN': 'Africa', 'CI': 'Africa', 'CM': 'Africa',
            'ET': 'Africa', 'UG': 'Africa', 'RW': 'Africa', 'AO': 'Africa',
            'MZ': 'Africa', 'MG': 'Africa', 'BJ': 'Africa', 'BF': 'Africa',
            'CD': 'Africa', 'ML': 'Africa', 'GN': 'Africa', 'ZM': 'Africa',
            'ZW': 'Africa', 'BW': 'Africa', 'NA': 'Africa', 'NE': 'Africa',
            'TD': 'Africa', 'MR': 'Africa', 'SO': 'Africa', 'LR': 'Africa',
            'SL': 'Africa', 'BI': 'Africa', 'ER': 'Africa', 'MW': 'Africa',
            'LS': 'Africa', 'SZ': 'Africa', 'DJ': 'Africa', 'GA': 'Africa',
            'CF': 'Africa', 'CG': 'Africa', 'SS': 'Africa', 'SD': 'Africa',
            'LY': 'Africa', 'MU': 'Africa', 'CV': 'Africa', 'GW': 'Africa'
        };

        const REGION_COLORS = {
            'Europe':       '#3b82f6',
            'Americas':     '#ef4444',
            'Asia-Pacific': '#10b981',
            'Middle East':  '#f59e0b',
            'Africa':       '#a855f7'
        };

        const REGION_EMOJIS = {
            'Europe': '🇪🇺', 'Americas': '🌎', 'Asia-Pacific': '🌏', 'Middle East': '🕌', 'Africa': '🌍'
        };

        function getRegion(code) {
            return REGION_MAP[code] || 'Other';
        }

        // Generate shades of a base color for drill-down countries
        function generateShades(hex, count) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            const shades = [];
            for (let i = 0; i < count; i++) {
                const factor = 0.5 + (i / Math.max(count - 1, 1)) * 0.7;
                shades.push(`rgb(${Math.round(r * factor)}, ${Math.round(g * factor)}, ${Math.round(b * factor)})`);
            }
            return shades.reverse();
        }

        function renderDonutRegions(regs) {
            currentDonutView = 'regions';
            document.getElementById('donut-title').textContent = 'Regional Distribution';
            document.getElementById('donut-subtitle').textContent = 'Registrations by region';
            document.getElementById('donut-back-btn').classList.add('hidden');
            document.getElementById('donut-back-btn').classList.remove('flex');

            // Aggregate by region
            const regionCount = {};
            regs.forEach(r => {
                const region = getRegion(r.country.code);
                regionCount[region] = (regionCount[region] || 0) + 1;
            });

            const labels = Object.keys(regionCount);
            const series = Object.values(regionCount);
            const colors = labels.map(l => REGION_COLORS[l] || '#6b7280');

            const opts = {
                series: series,
                labels: labels.map(l => `${REGION_EMOJIS[l] || '🌐'} ${l}`),
                chart: {
                    type: 'donut', height: 280, background: 'transparent',
                    fontFamily: 'Inter, sans-serif',
                    events: {
                        dataPointSelection: function(e, chart, opts) {
                            const regionName = labels[opts.dataPointIndex];
                            renderDonutDrillDown(regs, regionName);
                        }
                    }
                },
                colors: colors,
                stroke: { width: 2, colors: [document.documentElement.classList.contains('light-theme') ? '#ffffff' : '#0a0a0a'] },
                dataLabels: { enabled: false },
                legend: {
                    position: 'right',
                    labels: { colors: document.documentElement.classList.contains('light-theme') ? '#374151' : '#a1a1aa' },
                    fontSize: '12px',
                    fontFamily: 'Inter',
                    fontWeight: 500,
                    markers: { width: 10, height: 10, radius: 3 },
                    itemMargin: { vertical: 4 }
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: '68%',
                            labels: {
                                show: true,
                                name: { color: document.documentElement.classList.contains('light-theme') ? '#374151' : '#fff', fontSize: '11px', offsetY: -4 },
                                value: { color: '#fbbf24', fontSize: '20px', fontFamily: 'JetBrains Mono', fontWeight: 700, offsetY: 4 },
                                total: { show: true, label: 'Total', color: '#71717a', fontSize: '10px', formatter: () => regs.length }
                            }
                        },
                        expandOnClick: false
                    }
                },
                states: { hover: { filter: { type: 'lighten', value: 0.12 } } },
                theme: { mode: document.documentElement.classList.contains('light-theme') ? 'light' : 'dark' },
                tooltip: {
                    theme: document.documentElement.classList.contains('light-theme') ? 'light' : 'dark',
                    custom: function({ series, seriesIndex, w }) {
                        const lt = document.documentElement.classList.contains('light-theme');
                        const label = labels[seriesIndex];
                        const emoji = REGION_EMOJIS[label] || '🌐';
                        const val = series[seriesIndex];
                        const pct = ((val / regs.length) * 100).toFixed(1);
                        return `<div style="background:${lt ? 'rgba(255,255,255,0.96)' : '#1a1a1a'};border:1px solid ${lt ? 'rgba(0,0,0,0.10)' : 'rgba(255,255,255,0.1)'};padding:8px 12px;border-radius:8px;font-family:Inter;box-shadow:${lt ? '0 4px 20px rgba(0,0,0,0.18)' : 'none'}">
                            <span style="font-size:14px">${emoji}</span>
                            <span style="color:${lt ? '#1d1d1f' : '#fff'};font-weight:600;font-size:12px;margin-left:4px">${label}</span>
                            <div style="color:#fbbf24;font-size:13px;font-weight:700;font-family:JetBrains Mono;margin-top:2px">${val} registrations (${pct}%)</div>
                            <div style="color:#71717a;font-size:9px;margin-top:2px">Click to see countries →</div>
                        </div>`;
                    }
                }
            };

            if (countryDonutInstance) { countryDonutInstance.destroy(); countryDonutInstance = null; }
            const el = document.querySelector('#countryDonutChart');
            if (el) { countryDonutInstance = new ApexCharts(el, opts); countryDonutInstance.render(); }
        }

        function renderDonutDrillDown(regs, regionName) {
            currentDonutView = regionName;
            document.getElementById('donut-title').textContent = `${REGION_EMOJIS[regionName] || '🌐'} ${regionName}`;
            document.getElementById('donut-subtitle').textContent = 'Countries breakdown — click a slice or ← to go back';
            document.getElementById('donut-back-btn').classList.remove('hidden');
            document.getElementById('donut-back-btn').classList.add('flex');

            // Filter regs for this region
            const regionRegs = regs.filter(r => getRegion(r.country.code) === regionName);

            // Aggregate by country
            const countryData = {};
            regionRegs.forEach(r => {
                const key = r.country.name;
                if (!countryData[key]) countryData[key] = { count: 0, flag: r.country.flag, code: r.country.code };
                countryData[key].count++;
            });

            const countryNames = Object.keys(countryData).sort((a, b) => countryData[b].count - countryData[a].count);
            const series = countryNames.map(c => countryData[c].count);
            const baseColor = REGION_COLORS[regionName] || '#6b7280';
            const shades = generateShades(baseColor, countryNames.length);

            const opts = {
                series: series,
                labels: countryNames.map(c => `${countryData[c].flag || '🌍'} ${c}`),
                chart: {
                    type: 'donut', height: 280, background: 'transparent',
                    fontFamily: 'Inter, sans-serif',
                    animations: { enabled: true, easing: 'easeinout', speed: 500, dynamicAnimation: { enabled: true, speed: 350 } }
                },
                colors: shades,
                stroke: { width: 2, colors: [document.documentElement.classList.contains('light-theme') ? '#ffffff' : '#0a0a0a'] },
                dataLabels: { enabled: false },
                legend: {
                    position: 'right',
                    labels: { colors: document.documentElement.classList.contains('light-theme') ? '#374151' : '#a1a1aa' },
                    fontSize: '12px',
                    fontFamily: 'Inter',
                    fontWeight: 500,
                    markers: { width: 10, height: 10, radius: 3 },
                    itemMargin: { vertical: 3 },
                    formatter: function(label, opts) {
                        return `${label}  <span style="color:#fbbf24;font-family:JetBrains Mono;font-weight:700;font-size:11px">${opts.w.globals.series[opts.seriesIndex]}</span>`;
                    }
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: '68%',
                            labels: {
                                show: true,
                                name: { color: document.documentElement.classList.contains('light-theme') ? '#374151' : '#fff', fontSize: '11px', offsetY: -4 },
                                value: { color: baseColor, fontSize: '20px', fontFamily: 'JetBrains Mono', fontWeight: 700, offsetY: 4 },
                                total: {
                                    show: true,
                                    label: regionName,
                                    color: '#71717a',
                                    fontSize: '10px',
                                    formatter: () => regionRegs.length
                                }
                            }
                        }
                    }
                },
                theme: { mode: document.documentElement.classList.contains('light-theme') ? 'light' : 'dark' },
                tooltip: {
                    theme: document.documentElement.classList.contains('light-theme') ? 'light' : 'dark',
                    custom: function({ series, seriesIndex }) {
                        const lt = document.documentElement.classList.contains('light-theme');
                        const name = countryNames[seriesIndex];
                        const d = countryData[name];
                        const pct = ((d.count / regionRegs.length) * 100).toFixed(1);
                        return `<div style="background:${lt ? 'rgba(255,255,255,0.96)' : '#1a1a1a'};border:1px solid ${lt ? 'rgba(0,0,0,0.10)' : 'rgba(255,255,255,0.1)'};padding:8px 12px;border-radius:8px;font-family:Inter;box-shadow:${lt ? '0 4px 20px rgba(0,0,0,0.18)' : 'none'}">
                            <span style="font-size:16px">${d.flag}</span>
                            <span style="color:${lt ? '#1d1d1f' : '#fff'};font-weight:600;font-size:12px;margin-left:4px">${name}</span>
                            <span style="color:#71717a;font-size:10px;margin-left:4px">${d.code}</span>
                            <div style="color:${baseColor};font-size:13px;font-weight:700;font-family:JetBrains Mono;margin-top:2px">${d.count} registrations (${pct}%)</div>
                        </div>`;
                    }
                }
            };

            if (countryDonutInstance) { countryDonutInstance.destroy(); countryDonutInstance = null; }
            const el = document.querySelector('#countryDonutChart');
            if (el) { countryDonutInstance = new ApexCharts(el, opts); countryDonutInstance.render(); }
        }

        // Back button handler
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('donut-back-btn').addEventListener('click', () => {
                renderDonutRegions(cachedRegs);
            });
        });

        function updateCountryCharts(regs, earnings) {
            const database = window.db;
            if (!database) return;

            cachedRegs = regs;
            cachedEarnings = earnings;

            // Render donut (keep current view if drilling down)
            if (currentDonutView === 'regions') {
                renderDonutRegions(regs);
            } else {
                renderDonutDrillDown(regs, currentDonutView);
            }

            // Commission per country (bar) — only Commission/QCPA events
            const countryComm = {};
            const countryRegions = {};
            earnings.filter(e => e.type === 'Commission' || e.type === 'QCPA').forEach(e => {
                const user = database.registrations.find(u => u.userId === e.userId);
                const cName = (user && user.country) ? user.country.name : 'Unknown';
                const cCode = (user && user.country) ? user.country.code : '';
                const cFlag = (user && user.country) ? user.country.flag : '🌐';
                countryComm[cName] = (countryComm[cName] || 0) + (e.commission_amount || e.amount || 0);
                if (!countryRegions[cName]) countryRegions[cName] = { region: getRegion(cCode), flag: cFlag, code: cCode };
            });

            const barCategories = Object.keys(countryComm).sort((a, b) => countryComm[b] - countryComm[a]).slice(0, 10);
            const barData = barCategories.map(c => countryComm[c]);
            const barColors = barCategories.map(c => REGION_COLORS[countryRegions[c].region] || '#6b7280');
            const isMobileBar = window.innerWidth < 640;
            const barLabels = barCategories.map(c => {
                const cr = countryRegions[c];
                if (isMobileBar) {
                    // On mobile: show flag emoji + country code (e.g. 🇬🇧 GB)
                    return `${cr.flag || '🌍'} ${cr.code ? cr.code.toUpperCase() : c.substring(0, 3)}`;
                }
                return `${cr.flag || '🌍'} ${c}`;
            });

            const barOpts = {
                series: [{ name: 'Commission', data: barData }],
                chart: { type: 'bar', height: isMobileBar ? 240 : 280, background: 'transparent', fontFamily: 'JetBrains Mono, monospace', toolbar: { show: false } },
                colors: barColors,
                plotOptions: {
                    bar: { borderRadius: 4, horizontal: true, barHeight: '60%', distributed: true }
                },
                dataLabels: { enabled: true, formatter: v => '$' + v, style: { fontSize: isMobileBar ? '9px' : '10px', colors: [document.documentElement.classList.contains('light-theme') ? '#374151' : '#fff'] } },
                xaxis: {
                    categories: barLabels,
                    labels: { style: { colors: '#71717a', fontSize: isMobileBar ? '9px' : '10px' }, formatter: v => '$' + v }
                },
                yaxis: { labels: { style: { colors: document.documentElement.classList.contains('light-theme') ? '#6b7280' : '#d4d4d8', fontSize: isMobileBar ? '10px' : '11px' }, maxWidth: isMobileBar ? 60 : 160 } },
                grid: { borderColor: document.documentElement.classList.contains('light-theme') ? 'rgba(0,0,0,0.06)' : 'rgba(255,255,255,0.05)', strokeDashArray: 4 },
                legend: { show: false },
                theme: { mode: document.documentElement.classList.contains('light-theme') ? 'light' : 'dark' },
                tooltip: {
                    theme: document.documentElement.classList.contains('light-theme') ? 'light' : 'dark',
                    custom: function({ series, seriesIndex, dataPointIndex }) {
                        const lt = document.documentElement.classList.contains('light-theme');
                        const name = barCategories[dataPointIndex];
                        const info = countryRegions[name];
                        const val = series[seriesIndex][dataPointIndex];
                        const regionColor = REGION_COLORS[info.region] || '#6b7280';
                        return `<div style="background:${lt ? 'rgba(255,255,255,0.96)' : '#1a1a1a'};border:1px solid ${lt ? 'rgba(0,0,0,0.10)' : 'rgba(255,255,255,0.1)'};padding:8px 12px;border-radius:8px;font-family:Inter;box-shadow:${lt ? '0 4px 20px rgba(0,0,0,0.18)' : 'none'}">
                            <span style="font-size:14px">${info.flag}</span>
                            <span style="color:${lt ? '#1d1d1f' : '#fff'};font-weight:600;font-size:12px;margin-left:4px">${name}</span>
                            <div style="color:${regionColor};font-size:13px;font-weight:700;font-family:JetBrains Mono;margin-top:2px">$${val.toFixed(2)}</div>
                            <div style="color:#71717a;font-size:9px;margin-top:2px">${info.region}</div>
                        </div>`;
                    }
                }
            };

            if (countryBarInstance) {
                countryBarInstance.updateOptions({
                    series: [{ name: 'Commission', data: barData }],
                    xaxis: { categories: barLabels },
                    colors: barColors
                });
            } else {
                const el = document.querySelector('#countryBarChart');
                if (el) {
                    countryBarInstance = new ApexCharts(el, barOpts);
                    countryBarInstance.render();
                }
            }
        }

        // === TRANSACTION DETAIL MODAL ===
        const txnModal = document.getElementById('txn-detail-modal');
        const txnModalContent = document.getElementById('txn-modal-content');
        const txnModalBody = document.getElementById('txn-modal-body');

        function openTxnModal(tx) {
            const database = window.db;
            let countryName = 'Unknown', countryFlag = '🌍', countryCode = '';
            if (database) {
                const user = database.registrations.find(u => u.userId === tx.userId);
                if (user && user.country) { countryName = user.country.name; countryFlag = user.country.flag; countryCode = user.country.code || ''; }
            }
            const modalFlagHTML = `<span class="text-3xl">${countryFlag}</span>`;

            txnModalBody.innerHTML = `
                <div class="flex items-center gap-3 mb-2">
                    ${modalFlagHTML}
                    <div>
                        <p class="text-white font-bold text-lg">${tx.userId}</p>
                        <p class="text-xs text-gray-500">${countryName}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <div class="bg-white/5 rounded-lg p-3 border border-white/5">
                        <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Amount</p>
                        <p class="text-lg font-mono font-bold text-brand-500">$${tx.amount.toFixed(2)}</p>
                    </div>
                    <div class="bg-white/5 rounded-lg p-3 border border-white/5">
                        <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Type</p>
                        <p class="text-lg font-mono font-bold text-white">${tx.type}</p>
                    </div>
                    <div class="bg-white/5 rounded-lg p-3 border border-white/5">
                        <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Date</p>
                        <p class="text-sm font-mono text-white">${new Date(tx.created).toLocaleDateString()}</p>
                    </div>
                    <div class="bg-white/5 rounded-lg p-3 border border-white/5">
                        <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Time</p>
                        <p class="text-sm font-mono text-white">${new Date(tx.created).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</p>
                    </div>
                    <div class="bg-white/5 rounded-lg p-3 border border-white/5 col-span-2">
                        <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Transaction ID</p>
                        <p class="text-sm font-mono text-gray-300">${tx.id}</p>
                    </div>
                    ${(function() {
                        const s = (tx.status || 'pending').toLowerCase();
                        const cfg = {
                            paid:     { bg: 'bg-green-500/10',  border: 'border-green-500/20',  text: 'text-green-400',  icon: '✓', label: 'Paid' },
                            approved: { bg: 'bg-blue-500/10',   border: 'border-blue-500/20',   text: 'text-blue-400',   icon: '✓', label: 'Approved' },
                            pending:  { bg: 'bg-yellow-500/10', border: 'border-yellow-500/20', text: 'text-yellow-400', icon: '⏳', label: 'Pending' },
                            rejected: { bg: 'bg-red-500/10',    border: 'border-red-500/20',    text: 'text-red-400',    icon: '✗', label: 'Rejected' },
                            active:   { bg: 'bg-emerald-500/10',border: 'border-emerald-500/20',text: 'text-emerald-400',icon: '●', label: 'Active' }
                        };
                        const c = cfg[s] || cfg.pending;
                        return `<div class="${c.bg} rounded-lg p-3 border ${c.border} col-span-2">
                            <p class="text-[10px] ${c.text} uppercase tracking-wider mb-1">Status</p>
                            <p class="text-sm font-bold ${c.text}">${c.icon} ${c.label}</p>
                        </div>`;
                    })()}
                </div>
            `;

            txnModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                txnModal.classList.remove('opacity-0');
                txnModalContent.classList.remove('scale-95');
            });
            playNotifSound(800, 0.05, 0.08);
        }

        function closeTxnModal() {
            txnModal.classList.add('opacity-0');
            txnModalContent.classList.add('scale-95');
            setTimeout(() => txnModal.classList.add('hidden'), 300);
        }

        document.getElementById('close-txn-modal').addEventListener('click', closeTxnModal);
        txnModal.addEventListener('click', (e) => { if (e.target === txnModal) closeTxnModal(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !txnModal.classList.contains('hidden')) closeTxnModal(); });

        // === TRANSACTION FILTERS (custom dropdowns) ===
        function _initCustomFilter(wrapperId, btnId, labelId, dropdownId, optionsId, hiddenId) {
            const wrapper = document.getElementById(wrapperId);
            const btn = document.getElementById(btnId);
            const label = document.getElementById(labelId);
            const dd = document.getElementById(dropdownId);
            const optsContainer = document.getElementById(optionsId);
            const hidden = document.getElementById(hiddenId);
            if (!btn || !dd) return null;

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const open = !dd.classList.contains('hidden');
                document.querySelectorAll('.custom-select-dd-open').forEach(d => { d.classList.add('hidden'); d.classList.remove('custom-select-dd-open'); });
                if (!open) { dd.classList.remove('hidden'); dd.classList.add('custom-select-dd-open'); btn.querySelector('svg').classList.add('rotate-180'); }
                else { btn.querySelector('svg').classList.remove('rotate-180'); }
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#' + wrapperId)) { dd.classList.add('hidden'); btn.querySelector('svg').classList.remove('rotate-180'); }
            });

            return { btn, label, dd, optsContainer, hidden, setOptions(items) {
                optsContainer.innerHTML = items.map(it =>
                    `<div class="custom-select-opt px-3 py-2 text-[11px] cursor-pointer hover:bg-white/10 transition text-gray-300${hidden.value === it.value ? ' bg-white/5 font-medium' : ''}" data-value="${it.value}">${it.text}</div>`
                ).join('');
                optsContainer.querySelectorAll('.custom-select-opt').forEach(opt => {
                    opt.addEventListener('click', () => {
                        hidden.value = opt.dataset.value;
                        label.textContent = opt.textContent;
                        dd.classList.add('hidden');
                        btn.querySelector('svg').classList.remove('rotate-180');
                        optsContainer.querySelectorAll('.custom-select-opt').forEach(o => o.classList.remove('bg-white/5', 'font-medium'));
                        opt.classList.add('bg-white/5', 'font-medium');
                        hidden.dispatchEvent(new Event('change', { bubbles: true }));
                    });
                });
            }};
        }

        const txnCountryDD = _initCustomFilter('txn-country-wrapper', 'txn-country-btn', 'txn-country-label', 'txn-country-dropdown', 'txn-country-options', 'txn-country-filter');
        const txnAmountDD = _initCustomFilter('txn-amount-wrapper', 'txn-amount-btn', 'txn-amount-label', 'txn-amount-dropdown', 'txn-amount-options', 'txn-amount-filter');

        function populateCountryFilter() {
            if (!txnCountryDD || !window.db) return;
            const currentVal = txnCountryDD.hidden.value;
            const countries = [...new Set(window.db.registrations.map(r => r.country.name))].sort();
            const flagMap = {};
            window.db.registrations.forEach(r => { flagMap[r.country.name] = r.country.flag; });
            const items = [{ value: '', text: 'All Countries' }];
            countries.forEach(c => items.push({ value: c, text: `${flagMap[c] || ''} ${c}` }));
            txnCountryDD.setOptions(items);
            if (currentVal) txnCountryDD.hidden.value = currentVal;
        }

        function populateAmountFilter() {
            if (!txnAmountDD || !window.db) return;
            const currentVal = txnAmountDD.hidden.value;
            const amounts = [...new Set(window.db.earnings.map(e => e.amount).filter(a => a > 0))].sort((a, b) => a - b);
            const items = [{ value: '', text: 'All Amounts' }];
            amounts.forEach(a => items.push({ value: String(a), text: `$${a.toFixed(2)}` }));
            txnAmountDD.setOptions(items);
            if (currentVal) txnAmountDD.hidden.value = currentVal;
        }

        document.querySelectorAll('.txn-filter-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.txn-filter-btn').forEach(b => {
                    b.classList.remove('bg-brand-500', 'text-white', 'shadow-lg', 'shadow-brand-500/20');
                    b.classList.add('text-gray-400');
                });
                this.classList.add('bg-brand-500', 'text-white', 'shadow-lg', 'shadow-brand-500/20');
                this.classList.remove('text-gray-400');
                updateDashboardData();
            });
        });

        ['txn-country-filter', 'txn-amount-filter'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', () => updateDashboardData());
        });

        // === NOTIFICATION SOUND (Web Audio API) ===
        let audioCtx = null;
        function playNotifSound(freq, vol, dur) {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq || 880, audioCtx.currentTime);
                gain.gain.setValueAtTime(vol || 0.06, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + (dur || 0.15));
                osc.start();
                osc.stop(audioCtx.currentTime + (dur || 0.15));
            } catch(e) { /* silently fail */ }
        }

        // === KEYBOARD SHORTCUTS ===
        document.addEventListener('keydown', (e) => {
            // Don't trigger if user is typing in an input/select/textarea
            if (['INPUT', 'SELECT', 'TEXTAREA'].includes(e.target.tagName)) return;
            const key = e.key.toLowerCase();

            switch(key) {
                case 'g':
                    e.preventDefault();
                    const expandBtn = document.getElementById('expand-globe-btn');
                    if (expandBtn) expandBtn.click();
                    break;
                case 'r':
                    e.preventDefault();
                    window.location.href = '/reports';
                    break;
                case 'd':
                    e.preventDefault();
                    window.location.href = '/deals';
                    break;
                case '?':
                    e.preventDefault();
                    const shortcutsToast = document.getElementById('shortcuts-toast');
                    if (shortcutsToast) {
                        const isHidden = shortcutsToast.classList.contains('hidden');
                        if (isHidden) {
                            shortcutsToast.classList.remove('hidden');
                            requestAnimationFrame(() => shortcutsToast.classList.remove('opacity-0'));
                        } else {
                            shortcutsToast.classList.add('opacity-0');
                            setTimeout(() => shortcutsToast.classList.add('hidden'), 300);
                        }
                    }
                    break;
                case '1': case '2': case '3': case '4': case '5':
                    e.preventDefault();
                    const timeframes = ['today', 'last7', 'last30', 'mtd', 'all'];
                    const tfSelect = document.getElementById('dashboard-timeframe');
                    if (tfSelect) {
                        tfSelect.value = timeframes[parseInt(key) - 1];
                        tfSelect.dispatchEvent(new Event('change'));
                    }
                    break;
            }
        });

        // 3D Globe Implementation (D3.js)
        (function() {
            const canvas = document.getElementById("globeCanvas");
            if(!canvas) return;
            
            const context = canvas.getContext("2d");
            let width = canvas.parentElement.clientWidth;
            let height = canvas.parentElement.clientHeight;
            let projection, path, land;
            let rotation = { x: 0, y: 0 };
            let isExpanded = false;

            function initGlobe() {
                const dpr = window.devicePixelRatio || 1;
                canvas.width = width * dpr;
                canvas.height = height * dpr;
                canvas.style.width = width + "px";
                canvas.style.height = height + "px";
                context.scale(dpr, dpr);
                
                const minDim = Math.min(width, height);
                projection = d3.geoOrthographic()
                    .scale(minDim / 2.0)
                    .translate([width / 2, height / 2])
                    .clipAngle(90);
                
                path = d3.geoPath().projection(projection).context(context);
            }

            // Initial Setup
            initGlobe();

            // Re-init on container resize so mobile CSS overrides don't squash the globe
            if (typeof ResizeObserver !== 'undefined') {
                let resizeTimer;
                new ResizeObserver(() => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        const newW = canvas.parentElement.clientWidth;
                        const newH = canvas.parentElement.clientHeight;
                        if (newW !== width || newH !== height) {
                            width = newW;
                            height = newH;
                            initGlobe();
                        }
                    }, 150);
                }).observe(canvas.parentElement);
            }
            
            // Mock Data for Dots (Registrations=Yellow, Commissions=Red, Deposits=Blue)
            // Initial blank state, will be populated by updateDashboardData
            let markers = [];

            window.updateGlobeData = function(registrations, earnings) {
                markers = [];
                
                // Add ALL Registrations as Yellow dots
                // Each gets a unique tiny offset so dots at same country don't stack
                registrations.forEach((r, i) => {
                    if(r.country && r.country.coords) {
                        const offsetLon = (i % 5) * 1.5 - 3;
                        const offsetLat = Math.floor(i / 5) * 1.2 - 2;
                        markers.push({ type: 'reg', coords: [r.country.coords[0] + offsetLon, r.country.coords[1] + offsetLat] });
                    }
                });

                // Add FTD Deposits as Blue dots
                let depIndex = 0;
                registrations.forEach(r => {
                    if(r.firstDeposit > 0 && r.country && r.country.coords) {
                         const offsetLon = (depIndex % 4) * 1.8 + 4;
                         const offsetLat = Math.floor(depIndex / 4) * 1.4 + 2;
                         markers.push({ type: 'dep', coords: [r.country.coords[0] + offsetLon, r.country.coords[1] + offsetLat] });
                         depIndex++;
                    }
                });

                // Add Commission events as Red dots (only real commission, not QCPA)
                earnings.filter(e => e.type === 'Commission').forEach((e, i) => {
                     const database = window.db; 
                     if(database) {
                        const user = database.registrations.find(u => u.userId === e.userId);
                        if(user && user.country && user.country.coords) {
                             const offsetLon = (i % 4) * -1.8 - 3;
                             const offsetLat = Math.floor(i / 4) * -1.2 - 2;
                             markers.push({ type: 'comm', coords: [user.country.coords[0] + offsetLon, user.country.coords[1] + offsetLat] });     
                        }
                     }
                });
            };

            // Load Data
            d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(function(world) {
                land = topojson.feature(world, world.objects.countries);
                d3.timer(render);
            });

            // Drag Handler
            let v0, r0, q0;

            function dragstarted() {
                v0 = versor.cartesian(projection.invert(d3.pointer(event, this)));
                r0 = projection.rotate();
                q0 = versor(r0);
            }
            
            function dragged() {
                const v1 = versor.cartesian(projection.rotate(r0).invert(d3.pointer(event, this)));
                const q1 = versor.multiply(q0, versor.delta(v0, v1));
                const r1 = versor.rotation(q1);
                projection.rotate(r1);
                rotation.x = r1[0]; // Update auto-rotation sync
            }
            
            // Simplified Drag (XY only for this specific projection style if versor is too complex to shim)
            // Using D3 Drag directly on canvas
            d3.select(canvas).call(d3.drag()
                .on("start", (event) => {
                    // Pause auto rotation on interaction
                    isDragging = true;
                    // Store initial
                    dragStartCoords = [event.x, event.y];
                    dragStartRotation = projection.rotate();
                })
                .on("drag", (event) => {
                    const dx = event.x - dragStartCoords[0];
                    const dy = event.y - dragStartCoords[1];
                    // Update projection
                    const sensitivity = 0.25;
                    rotation.x = dragStartRotation[0] + dx * sensitivity;
                    projection.rotate([rotation.x, -15 + (dy * sensitivity)]); 
                    // Render immediate
                    // context.clearRect(0,0,width,height); render(); // Render loop handles it
                })
                .on("end", () => {
                    isDragging = false;
                })
            );
            
            let isDragging = false;
            let dragStartCoords = [0,0];
            let dragStartRotation = [0,0];

            function render() {
                if(!isDragging) {
                    rotation.x += 0.2; 
                    projection.rotate([rotation.x, -15]);
                }
                
                const isLight = document.documentElement.classList.contains('light-theme');
                context.clearRect(0, 0, width, height);
                // Atmosphere / Ocean
                context.beginPath(); 
                path({type: "Sphere"}); 
                context.fillStyle = isLight ? "rgba(220,38,38,0.06)" : "rgba(0,0,0,0.3)"; 
                context.fill();
                
                // Graticule
                context.beginPath(); 
                path(d3.geoGraticule10()); 
                context.strokeStyle = isLight ? "rgba(220,38,38,0.08)" : "rgba(220,38,38,0.1)"; 
                context.stroke();
                
                // Land
                if (land) { 
                    context.beginPath(); 
                    path(land); 
                    context.fillStyle = isLight ? "#dc2626" : "#5a1010"; 
                    context.fill(); 
                    context.strokeStyle = isLight ? "#ef4444" : "#b91c1c"; 
                    context.lineWidth = 0.5; 
                    context.stroke(); 
                }
                
                // Markers
                const time = Date.now();
                path.pointRadius(3); // Dot size for globe markers
                
                markers.forEach(m => {
                    const p = { type: "Point", coordinates: m.coords };
                    
                    // Check if point is roughly visible (simple logic or rely on path clipping)
                    // Path clipping is automatic with .clipAngle(90) set in init
                    
                    context.beginPath();
                    path(p);
                    
                    let color, glowColor;
                    if(m.type === 'reg') {
                        color = "#fcd34d"; // Brighter Yellow
                        glowColor = "rgba(253, 224, 71, 1)";
                    } else if(m.type === 'comm') {
                        color = "#f87171"; // Brighter Red
                        glowColor = "rgba(248, 113, 113, 1)";
                    } else {
                        color = "#60a5fa"; // Brighter Blue
                        glowColor = "rgba(96, 165, 250, 1)";
                    }
                    
                    // Pulsing effect calculation
                    // Creates a breathing effect varying between 20 and 50 (Intensified)
                    const pulse = 20 + Math.abs(Math.sin(time * 0.003)) * 30;
                    
                    context.fillStyle = color;
                    context.shadowColor = glowColor;
                    context.shadowBlur = pulse; // Dynamic pulse
                    
                    context.fill();
                    
                    // Remove white core, just pure color with glow
                    context.shadowBlur = 0; // Reset
                });
                
                // Gradient Overlay
                const gradient = context.createRadialGradient(width/2, height/2, height/2.2 - 20, width/2, height/2, height/2.2 + 40);
                gradient.addColorStop(0, "rgba(220, 38, 38, 0)"); 
                gradient.addColorStop(0.5, "rgba(220, 38, 38, 0.1)");
                
                context.beginPath(); 
                path({type: "Sphere"}); 
                context.fillStyle = gradient; 
                context.fill();
            }

            // Expand Modal Logic
            const expandBtn = document.getElementById('expand-globe-btn');
            
            // Create Modal DOM
            const modal = document.createElement('div');
            const isLt = document.documentElement.classList.contains('light-theme');
            modal.className = "fixed inset-0 z-[9999] flex flex-col hidden opacity-0 transition-opacity duration-300";
            modal.style.background = isLt
                ? "radial-gradient(ellipse at center, #fde8e8 0%, #fdf2f2 50%, #f9fafb 100%)"
                : "radial-gradient(ellipse at center, #450a0a 0%, #1a0505 50%, #050505 100%)";
            modal.id = "globe-modal";
            const _hdrBg = isLt ? '' : 'bg-gradient-to-b from-black/80 to-transparent';
            const _ftrBg = isLt ? '' : 'bg-gradient-to-t from-black/90 to-transparent backdrop-blur-sm';
            const _cardBg = isLt ? 'bg-white/70 border-gray-200' : 'bg-black/50 border-white/10';
            const _titleClr = isLt ? 'text-gray-900' : 'text-white';
            const _btnCls = isLt ? 'bg-black/5 hover:bg-black/10 text-gray-800 border-gray-300' : 'bg-white/10 hover:bg-white/20 text-white border-white/10';
            const _nameClr = isLt ? 'text-gray-900' : 'text-white';
            const _subClr = isLt ? 'text-gray-500' : 'text-gray-400';
            const _lblClr = isLt ? 'text-gray-500' : 'text-gray-500';
            modal.innerHTML = `
                <!-- Modal Header -->
                <div class="absolute top-0 left-0 w-full z-10 flex justify-between items-center p-8 ${_hdrBg} pointer-events-none">
                    <div class="pointer-events-auto">
                        <h2 class="text-2xl font-bold ${_titleClr} tracking-widest uppercase" data-i18n="globe.liveActivity">Live Activity</h2>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                            <span class="text-xs font-mono text-green-500" data-i18n="globe.systemOnline">SYSTEM ONLINE</span>
                        </div>
                    </div>
                    <button id="close-globe-modal" class="pointer-events-auto ${_btnCls} px-6 py-2 rounded-lg font-mono text-xs uppercase transition backdrop-blur-md border" data-i18n="globe.escClose">ESC / Close</button>
                </div>

                <!-- Globe Container (Canvas will be moved here) -->
                <div class="flex-1 relative flex items-center justify-center cursor-move" id="modal-globe-container">
                    <!-- Placeholder -->
                </div>

                <!-- Modal Footer Stats -->
                <div class="absolute bottom-0 left-0 w-full z-10 grid grid-cols-1 md:grid-cols-3 gap-8 p-8 ${_ftrBg} pointer-events-none">
                     <div class="${_cardBg} border rounded-xl p-4 pointer-events-auto">
                        <p class="text-[10px] ${_lblClr} font-mono uppercase tracking-wider mb-1" data-i18n="globe.latestReg">Latest Registration</p>
                        <div class="flex items-center gap-3" id="modal-latest-reg">
                            <span class="text-2xl">—</span>
                            <div>
                                <p class="${_nameClr} font-bold text-sm">Loading…</p>
                                <p class="text-[10px] ${_subClr}"></p>
                            </div>
                        </div>
                     </div>
                     <div class="${_cardBg} border rounded-xl p-4 pointer-events-auto">
                        <p class="text-[10px] ${_lblClr} font-mono uppercase tracking-wider mb-1" data-i18n="globe.latestComm">Latest Commission</p>
                        <div class="flex items-center gap-3" id="modal-latest-ftd">
                            <span class="text-2xl">—</span>
                            <div>
                                <p class="${_nameClr} font-bold text-sm">Loading…</p>
                                <p class="text-[10px] ${_subClr}"></p>
                            </div>
                        </div>
                     </div>
                     <div class="${_cardBg} border rounded-xl p-4 pointer-events-auto">
                        <p class="text-[10px] ${_lblClr} font-mono uppercase tracking-wider mb-1" data-i18n="globe.lifetimeEarnings">Lifetime Earnings</p>
                        <div class="flex items-center gap-3" id="modal-lifetime-earnings">
                            <span class="text-2xl text-green-400"><svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></span>
                            <div>
                                <p class="text-green-400 font-bold text-lg" id="modal-total-amount">$0.00</p>
                                <p class="text-[10px] ${_subClr}" id="modal-total-txns">0 commissions</p>
                            </div>
                        </div>
                     </div>
                </div>
            `;
            document.body.appendChild(modal);

            const originalContainer = document.getElementById('globe-container');
            const closeBtn = modal.querySelector('#close-globe-modal');
            const modalContainer = modal.querySelector('#modal-globe-container');

            function populateModalStats() {
                const d = window.db;
                const _lt = document.documentElement.classList.contains('light-theme');
                const _nc = _lt ? 'text-gray-900' : 'text-white';
                const _sc = _lt ? 'text-gray-500' : 'text-gray-400';
                // Latest Registration
                const latestReg = d.registrations[0];
                if(latestReg) {
                    const c = latestReg.country || {};
                    const ago = Math.round((Date.now() - new Date(latestReg.date).getTime()) / 60000);
                    const agoStr = ago < 60 ? ago + 'm ago' : Math.round(ago/60) + 'h ago';
                    const regFlagHTML = `<span class="text-2xl">${c.flag || '🌍'}</span>`;
                    document.getElementById('modal-latest-reg').innerHTML = `
                        ${regFlagHTML}
                        <div><p class="${_nc} font-bold text-sm">${latestReg.userId}</p>
                        <p class="text-[10px] ${_sc}">${c.name || 'Unknown'} • ${agoStr}</p></div>`;
                }
                // Latest Commission
                const latestEarn = d.earnings[0];
                if(latestEarn) {
                    const cc = latestEarn.userId.split('-')[0].toUpperCase();
                    const c = d.countries.find(x => x.code === cc) || {};
                    const ago2 = Math.round((Date.now() - new Date(latestEarn.created).getTime()) / 60000);
                    const agoStr2 = ago2 < 60 ? ago2 + 'm ago' : Math.round(ago2/60) + 'h ago';
                    document.getElementById('modal-latest-ftd').innerHTML = `
                        <span class="text-2xl">${c.flag || '🌍'}</span>
                        <div><p class="${_nc} font-bold text-sm">$${latestEarn.amount.toFixed(2)} ${latestEarn.type}</p>
                        <p class="text-[10px] ${_sc}">${c.name || cc} • ${agoStr2}</p></div>`;
                }
                // Lifetime Earnings — use backend total_earned (accurate), fallback to summing only commissions
                const total = typeof window._lifetimeEarned === 'number'
                    ? window._lifetimeEarned
                    : d.earnings.filter(e => e.type === 'Commission' || e.type === 'QCPA').reduce((s, e) => s + (e.commission_amount || e.amount || 0), 0);
                const commCount = d.earnings.filter(e => e.type === 'Commission' || e.type === 'QCPA').length;
                document.getElementById('modal-total-amount').textContent = '$' + total.toLocaleString('en-US', {minimumFractionDigits:2});
                document.getElementById('modal-total-txns').textContent = commCount + ' commissions';
            }

            function toggleGlobeView() {
                isExpanded = !isExpanded;
                
                if(isExpanded) {
                    // Open Modal
                    modal.classList.remove('hidden');
                    populateModalStats();
                    // Small delay to allow display:flex to apply before opacity transition
                    requestAnimationFrame(() => modal.classList.remove('opacity-0'));
                    
                    // Move Canvas
                    modalContainer.appendChild(canvas);
                    
                    // Resize — use container dimensions so globe stays round
                    requestAnimationFrame(() => {
                        width = modalContainer.clientWidth;
                        height = modalContainer.clientHeight;
                        initGlobe();
                    });

                } else {
                    // Close Modal
                    modal.classList.add('opacity-0');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                    
                    // Move Canvas Back
                    originalContainer.appendChild(canvas);
                    
                    // Resize Back — use a rAF so the container has settled to its CSS height
                    requestAnimationFrame(() => {
                        width = originalContainer.clientWidth;
                        height = Math.min(originalContainer.clientHeight, 220);
                        initGlobe();
                    });
                }
            }

            if(expandBtn) expandBtn.addEventListener('click', toggleGlobeView);
            closeBtn.addEventListener('click', toggleGlobeView);
            
            // ESC Key support
            document.addEventListener('keydown', (e) => {
                if(e.key === "Escape" && isExpanded) toggleGlobeView();
            });

        })();
    </script>

    <!-- ════════ QR CODE MODAL (body-level for correct positioning) ════════ -->
    <div id="qr-modal" style="display:none;" class="fixed inset-0 z-[9999] bg-black/70 backdrop-blur-sm">
        <div class="absolute inset-0" onclick="closeQRModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-8 pointer-events-none">
            <div class="glass-panel rounded-2xl p-6 w-full max-w-[300px] mx-auto text-center border border-white/10 pointer-events-auto shadow-2xl shadow-black/50" style="background:rgba(12,12,12,0.95);">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-xs font-bold text-white uppercase tracking-wider">QR Code</h3>
                    <button onclick="closeQRModal()" class="w-7 h-7 flex items-center justify-center rounded-lg hover:bg-white/10 text-gray-400 hover:text-white transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <p id="qr-broker-name" class="text-[10px] text-gray-500 mb-3">Broker Link</p>
                <div id="qr-canvas" class="flex items-center justify-center mb-3 bg-white rounded-xl p-3 mx-auto" style="width:200px;height:200px;"></div>
                <p id="qr-link-text" class="text-[10px] text-gray-600 font-mono truncate mb-4 px-1"></p>
                <div class="flex gap-2">
                    <button onclick="downloadQR()" class="flex-1 btn-gradient py-2.5 rounded-xl text-[10px] font-bold text-white uppercase tracking-wider shadow-lg shadow-brand-500/20 hover:shadow-brand-500/40 transition">Download</button>
                    <button onclick="closeQRModal()" class="flex-1 py-2.5 rounded-xl text-[10px] font-bold text-gray-400 uppercase tracking-wider border border-white/10 hover:bg-white/5 hover:text-white transition">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ════════ PAYOUT MODAL ════════ -->
    <div id="payout-modal" class="fixed inset-0 z-[9999] hidden opacity-0 transition-all duration-300" style="background:rgba(0,0,0,0.85); backdrop-filter:blur(8px);">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="glass-panel w-full max-w-xl rounded-2xl border border-white/10 shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300" id="payout-modal-content">
                
                <!-- Header -->
                <div class="px-5 py-3.5 border-b border-white/5 bg-gradient-to-r from-brand-600/10 to-transparent flex items-center justify-between">
                    <div class="flex items-center gap-2.5">
                        <div class="w-8 h-8 rounded-lg bg-brand-500/10 flex items-center justify-center">
                            <svg class="w-4 h-4 text-brand-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                        </div>
                        <div>
                            <h2 class="text-sm font-bold text-white" data-i18n="payout.title">Request Payout</h2>
                            <p class="text-[9px] text-gray-500 font-mono uppercase tracking-wider" id="payout-modal-subtitle">Commissions from previous month(s)</p>
                        </div>
                    </div>
                    <button onclick="closePayoutModal()" class="p-1.5 text-gray-500 hover:text-white transition rounded-lg hover:bg-white/5">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>

                <!-- Body -->
                <div class="p-5 space-y-3.5">
                    
                    <!-- Balance Overview — 4 cols compact -->
                    <div class="grid grid-cols-4 gap-2">
                        <div class="p-2.5 rounded-lg bg-green-500/5 border border-green-500/10">
                            <p class="text-[8px] text-gray-500 uppercase tracking-widest mb-0.5" data-i18n="payout.available">Available</p>
                            <p class="text-base font-mono font-bold text-green-400" id="payout-available">$0.00</p>
                            <p class="text-[7px] text-gray-600" id="payout-available-sub2">Previous months</p>
                        </div>
                        <div class="p-2.5 rounded-lg bg-yellow-500/5 border border-yellow-500/10">
                            <p class="text-[8px] text-gray-500 uppercase tracking-widest mb-0.5" data-i18n="payout.pending">Pending</p>
                            <p class="text-base font-mono font-bold text-yellow-400" id="payout-pending">$0.00</p>
                        </div>
                        <div class="p-2.5 rounded-lg bg-white/[0.02] border border-white/5">
                            <p class="text-[8px] text-gray-500 uppercase tracking-widest mb-0.5" data-i18n="payout.earned">Earned</p>
                            <p class="text-sm font-mono font-bold text-white" id="payout-earned">$0.00</p>
                        </div>
                        <div class="p-2.5 rounded-lg bg-white/[0.02] border border-white/5">
                            <p class="text-[8px] text-gray-500 uppercase tracking-widest mb-0.5" data-i18n="payout.paid">Paid</p>
                            <p class="text-sm font-mono font-bold text-white" id="payout-paid">$0.00</p>
                        </div>
                    </div>

                    <!-- Schedule + Withdrawal Amount — inline -->
                    <div class="flex gap-2">
                        <div class="flex-1 p-2.5 rounded-lg bg-blue-500/5 border border-blue-500/10 flex items-center gap-2">
                            <svg class="w-4 h-4 text-blue-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            <div class="min-w-0">
                                <p class="text-[8px] text-gray-500 uppercase tracking-widest" data-i18n="payout.nextPayout">Next Payout</p>
                                <p class="text-[11px] font-bold text-blue-400 truncate" id="payout-next-date">--</p>
                            </div>
                            <div class="ml-auto text-right flex-shrink-0">
                                <p class="text-[8px] text-gray-600 uppercase tracking-widest" data-i18n="payout.schedule">Schedule</p>
                                <p class="text-[9px] text-gray-400" id="payout-schedule-label">Loading...</p>
                            </div>
                        </div>
                        <div class="w-44 flex-shrink-0 p-2.5 rounded-lg bg-brand-500/5 border border-brand-500/20">
                            <p class="text-[8px] text-gray-500 uppercase tracking-widest mb-0.5" data-i18n="payout.withdrawal">Withdrawal</p>
                            <p class="text-base font-mono font-bold text-brand-500" id="payout-withdrawal-amount">$0.00</p>
                            <p class="text-[8px] text-gray-600 font-mono">Full balance · Min $100</p>
                        </div>
                    </div>

                    <!-- Payment Method + Wallet — side by side -->
                    <div class="grid grid-cols-[auto_1fr] gap-3">
                        <div>
                            <label class="text-[9px] font-mono text-gray-500 mb-1.5 block uppercase tracking-widest" data-i18n="payout.network">Network</label>
                            <div class="flex flex-col gap-1.5">
                                <label class="cursor-pointer">
                                    <input type="radio" name="payout_method" value="trc20" checked class="peer sr-only">
                                    <div class="px-3 py-1.5 rounded-lg border border-white/10 bg-white/[0.02] text-center peer-checked:border-brand-500 peer-checked:bg-brand-500/10 transition-all whitespace-nowrap">
                                        <span class="text-[10px] font-bold text-white">USDT</span> <span class="text-[8px] text-gray-400">TRC-20</span>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="payout_method" value="bep20" class="peer sr-only">
                                    <div class="px-3 py-1.5 rounded-lg border border-white/10 bg-white/[0.02] text-center peer-checked:border-brand-500 peer-checked:bg-brand-500/10 transition-all whitespace-nowrap">
                                        <span class="text-[10px] font-bold text-white">USDT</span> <span class="text-[8px] text-gray-400">BEP-20</span>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="payout_method" value="btc" class="peer sr-only">
                                    <div class="px-3 py-1.5 rounded-lg border border-white/10 bg-white/[0.02] text-center peer-checked:border-brand-500 peer-checked:bg-brand-500/10 transition-all whitespace-nowrap">
                                        <span class="text-[10px] font-bold text-white">BTC</span> <span class="text-[8px] text-gray-400">Native</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-[9px] font-mono text-gray-500 mb-1.5 block uppercase tracking-widest" data-i18n="payout.walletAddress">Wallet Address</label>
                            <input type="text" id="payout-wallet" placeholder="Paste your wallet address" data-i18n-ph="payout.walletPh" class="flex-1 w-full px-3 py-2.5 rounded-lg text-xs font-mono text-brand-500 bg-white/5 border border-white/10 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/20 transition">
                            <p class="text-[8px] text-brand-500/60 mt-1 flex items-center gap-1">
                                <svg class="w-3 h-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                <span data-i18n="payout.networkWarn">Verify the network carefully. Wrong network = permanent loss.</span>
                            </p>
                        </div>
                    </div>

                    <!-- Submit -->
                    <button id="payout-submit-btn" onclick="submitPayoutRequest()" class="w-full btn-gradient py-3 rounded-xl text-xs font-bold text-white uppercase tracking-widest hover:opacity-90 transition transform active:scale-[0.98] shadow-lg shadow-brand-600/20 flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                        <span data-i18n="payout.submit">Submit Payout Request</span>
                    </button>

                    <!-- Payout Message -->
                    <div id="payout-msg" class="hidden text-center text-sm p-2.5 rounded-lg border"></div>

                    <!-- Recent Payouts -->
                    <div id="payout-history-section" class="hidden">
                        <p class="text-[9px] font-mono text-gray-500 uppercase tracking-widest mb-1.5">Recent Payouts</p>
                        <div class="max-h-[100px] overflow-y-auto space-y-1" id="payout-history-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ── Payout Modal Logic ──
    let _payoutAvailable = 0;
    let _hasPendingRequest = false;
    let _payoutSchedule = "1,15"; // default, overridden by settings

    const SCHEDULE_LABELS = {
      "1,15": "1st & 15th of each month",
      "1": "1st of each month",
      "15": "15th of each month",
      "weekly": "Weekly (every Monday)",
      "end_of_month": "End of month",
      "end_of_month_26": "End of month (26th)",
      "sm_daily": "Daily (same month)",
      "sm_weekly": "Weekly (same month)",
      "sm_biweekly": "Biweekly (same month)",
      "sm_1,15": "1st & 15th (same month)",
      "sm_1": "1st of each month (same month)",
      "sm_15": "15th of each month (same month)",
      "sm_end_of_month_26": "End of month — 26th (same month)"
    };

    const CRYPTO_DISPLAY = {
      "trc20": "USDT TRC-20", "bep20": "USDT BEP-20", "btc": "BTC Native",
      "USDT-TRC20": "USDT TRC-20", "USDT-BEP20": "USDT BEP-20", "USDT-ERC20": "USDT ERC-20",
      "BTC-Native": "BTC Native", "ETH-ERC20": "ETH ERC-20", "LTC-Native": "LTC Native"
    };

    // ── PDF Invoice Generator ──
    function generatePayoutInvoice(payout) {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'mm', format: 'a4' });

        const amount = parseFloat(payout.amount || 0).toFixed(2);
        const method = CRYPTO_DISPLAY[payout.payment_method] || payout.payment_method || 'N/A';
        const wallet = payout.wallet_address || 'N/A';
        const status = (payout.status || 'pending').toUpperCase();
        const reqDate = payout.requested_at ? new Date(payout.requested_at) : new Date();
        const paidDate = payout.paid_at ? new Date(payout.paid_at) : null;
        const invoiceNo = 'INV-' + reqDate.getFullYear() + String(reqDate.getMonth()+1).padStart(2,'0') + String(reqDate.getDate()).padStart(2,'0') + '-' + (payout.id ? String(payout.id).slice(-4) : Math.random().toString(36).slice(2,6).toUpperCase());

        // Get affiliate info from localStorage
        const cached = JSON.parse(localStorage.getItem('tfxs_settings') || '{}');
        const displayName = cached.displayName || 'Affiliate';
        const email = cached.email || '';
        const afp = localStorage.getItem('affiliate_id') || '';

        // ── Header background ──
        doc.setFillColor(10, 10, 10);
        doc.rect(0, 0, 210, 45, 'F');
        doc.setFillColor(220, 38, 38);
        doc.rect(0, 43, 210, 2, 'F');

        // ── Company name ──
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(22);
        doc.setTextColor(255, 255, 255);
        doc.text('TFXS AFFILIATES', 20, 22);

        doc.setFontSize(9);
        doc.setTextColor(180, 180, 180);
        doc.text('Payout Invoice', 20, 30);

        // ── Invoice number & date (right side) ──
        doc.setFontSize(9);
        doc.setTextColor(255, 255, 255);
        doc.text(invoiceNo, 190, 22, { align: 'right' });
        doc.setTextColor(180, 180, 180);
        doc.text(reqDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }), 190, 30, { align: 'right' });

        // ── Bill To ──
        let y = 58;
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text('BILL TO', 20, y);
        y += 7;
        doc.setFontSize(11);
        doc.setTextColor(30, 30, 30);
        doc.setFont('helvetica', 'bold');
        doc.text(displayName, 20, y);
        y += 5;
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(100, 100, 100);
        if (email) { doc.text(email, 20, y); y += 5; }
        if (afp) { doc.text('AFP: ' + afp, 20, y); y += 5; }

        // ── Status badge (right) ──
        const statusColors = { PENDING: [234,179,8], APPROVED: [59,130,246], PAID: [34,197,94], REJECTED: [239,68,68] };
        const sc = statusColors[status] || [150,150,150];
        doc.setFillColor(sc[0], sc[1], sc[2]);
        doc.roundedRect(155, 55, 35, 8, 2, 2, 'F');
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(255, 255, 255);
        doc.text(status, 172.5, 60.5, { align: 'center' });

        // ── Line items table ──
        y = 95;
        // Header row
        doc.setFillColor(245, 245, 247);
        doc.rect(20, y - 5, 170, 10, 'F');
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(100, 100, 100);
        doc.text('DESCRIPTION', 25, y);
        doc.text('NETWORK', 95, y);
        doc.text('AMOUNT', 185, y, { align: 'right' });

        // Data row
        y += 12;
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(30, 30, 30);
        doc.setFontSize(10);
        doc.text('Affiliate Payout', 25, y);
        doc.setFontSize(9);
        doc.setTextColor(100, 100, 100);
        doc.text(method, 95, y);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(30, 30, 30);
        doc.text('$' + amount, 185, y, { align: 'right' });

        // Divider
        y += 8;
        doc.setDrawColor(230, 230, 230);
        doc.line(20, y, 190, y);

        // ── Total ──
        y += 10;
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(100, 100, 100);
        doc.text('Total', 140, y);
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(220, 38, 38);
        doc.text('$' + amount, 185, y, { align: 'right' });

        // ── Payment details ──
        y += 20;
        doc.setFillColor(250, 250, 252);
        doc.roundedRect(20, y - 5, 170, 30, 3, 3, 'F');
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(100, 100, 100);
        doc.text('PAYMENT DETAILS', 25, y);
        y += 7;
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(60, 60, 60);
        doc.setFontSize(9);
        doc.text('Network: ' + method, 25, y);
        y += 5;
        doc.text('Wallet: ' + (wallet.length > 50 ? wallet.slice(0, 25) + '...' + wallet.slice(-10) : wallet), 25, y);
        y += 5;
        if (paidDate) { doc.text('Paid: ' + paidDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }), 25, y); }

        // ── Footer ──
        doc.setFontSize(7);
        doc.setTextColor(180, 180, 180);
        doc.text('This invoice was generated automatically by TFXS Affiliates. For questions, contact support.', 105, 275, { align: 'center' });
        doc.setFillColor(220, 38, 38);
        doc.rect(0, 290, 210, 7, 'F');

        // Save
        doc.save('TFXS-Invoice-' + invoiceNo + '.pdf');
        if (typeof showToast === 'function') showToast('Invoice downloaded!', 'success');
      } catch (err) {
        console.error('[PDF] Invoice generation failed:', err);
        if (typeof showToast === 'function') showToast('PDF generation failed', 'error');
      }
    }

    // Returns { next: Date, current: Date|null }
    function getPayoutDates(schedule) {
        const s = schedule || _payoutSchedule || "1,15";
        const isSM = s.startsWith("sm_");
        const base = isSM ? s.replace(/^sm_/, "") : s;
        const now = new Date();
        const y = now.getFullYear(), m = now.getMonth(), d = now.getDate();

        if (base === "daily") {
            // Daily: next payout is today (always open)
            return { next: new Date(y, m, d), current: new Date(y, m, d) };
        }

        if (base === "weekly") {
            const dayOfWeek = now.getDay();
            const daysUntilMon = dayOfWeek === 0 ? 1 : dayOfWeek === 1 ? 7 : (8 - dayOfWeek);
            const daysSinceLastMon = dayOfWeek === 1 ? 0 : dayOfWeek === 0 ? 6 : (dayOfWeek - 1);
            return { next: new Date(y, m, d + daysUntilMon), current: new Date(y, m, d - daysSinceLastMon) };
        }

        if (base === "biweekly") {
            // Biweekly = 1st & 15th
            if (d < 1) return { next: new Date(y, m, 1), current: new Date(y, m - 1, 15) };
            if (d < 15) return { next: new Date(y, m, 15), current: new Date(y, m, 1) };
            return { next: new Date(y, m + 1, 1), current: new Date(y, m, 15) };
        }

        if (base.startsWith("end_of_month")) {
            const eomDay = parseInt(base.split("_").pop()) || 26;
            if (d < eomDay) {
                const prevMonth = m === 0 ? new Date(y - 1, 11, eomDay) : new Date(y, m - 1, eomDay);
                return { next: new Date(y, m, eomDay), current: prevMonth };
            }
            return { next: new Date(y, m + 1, eomDay), current: new Date(y, m, eomDay) };
        }

        // Numeric day-based schedules (e.g. "1,15", "1", "15")
        const days = base.split(",").map(Number).filter(n => !isNaN(n)).sort((a, b) => a - b);
        if (days.length === 0) return { next: new Date(y, m + 1, 1), current: null };
        for (let i = 0; i < days.length; i++) {
            if (d < days[i]) {
                const prev = i > 0 ? new Date(y, m, days[i - 1]) : new Date(y, m - 1, days[days.length - 1]);
                return { next: new Date(y, m, days[i]), current: prev };
            }
        }
        return { next: new Date(y, m + 1, days[0]), current: new Date(y, m, days[days.length - 1]) };
    }

    function getNextPayoutDate(schedule) {
        return getPayoutDates(schedule).next;
    }

    async function loadPayoutScheduleFromSettings() {
        const API = window.TFXS_API;
        if (!API) return;
        try {
            const affiliateId = API.getAffiliateId();
            const res = await API.fetchPayoutSchedule(affiliateId);
            if (res.ok && res.schedule) {
                _payoutSchedule = res.schedule;
            }
        } catch (e) { console.warn("[Payout] Could not load schedule:", e.message); }
    }

    const PAYOUT_WINDOW_DAYS = 3;

    function updatePayoutSubmitButton() {
        const btn = document.getElementById('payout-submit-btn');
        if (!btn) return;

        // Hide any leftover success/error message when state changes
        const msg = document.getElementById('payout-msg');
        if (msg) msg.classList.add('hidden');

        // If there's already a pending/approved payout request → amber locked button
        if (_hasPendingRequest) {
            btn.disabled = true;
            btn.onclick = null;
            btn.classList.remove('btn-gradient');
            btn.classList.add('cursor-not-allowed');
            btn.style.cssText = 'background: linear-gradient(135deg, rgba(245,158,11,0.15) 0%, rgba(217,119,6,0.10) 100%); border: 1px solid rgba(245,158,11,0.25); box-shadow: 0 0 20px rgba(245,158,11,0.05);';
            btn.innerHTML = '<svg class="w-4 h-4 text-amber-400 animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> <span class="text-amber-400">Payout Pending — Awaiting Admin Review</span>';
            return;
        }

        const s = _payoutSchedule || "1,15";
        const base = s.startsWith("sm_") ? s.replace(/^sm_/, "") : s;

        // sm_daily = always open
        if (base === "daily") {
            btn.disabled = false;
            btn.onclick = submitPayoutRequest;
            btn.classList.add('btn-gradient');
            btn.classList.remove('cursor-not-allowed');
            btn.style.cssText = '';
            btn.innerHTML = '<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Submit Payout Request <span class="text-[9px] opacity-70 ml-1">(always available)</span>';
            return;
        }

        const { next, current } = getPayoutDates();
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const payoutDay = current ? new Date(current.getFullYear(), current.getMonth(), current.getDate()) : null;
        const nextDay = new Date(next.getFullYear(), next.getMonth(), next.getDate());

        let inWindow = false;
        let windowEnd = null;
        if (payoutDay) {
            windowEnd = new Date(payoutDay);
            windowEnd.setDate(windowEnd.getDate() + PAYOUT_WINDOW_DAYS);
            inWindow = today >= payoutDay && today < windowEnd;
        }

        if (inWindow) {
            btn.disabled = false;
            btn.onclick = submitPayoutRequest;
            btn.classList.add('btn-gradient');
            btn.classList.remove('cursor-not-allowed');
            btn.style.cssText = '';
            const daysLeft = Math.ceil((windowEnd - today) / (1000 * 60 * 60 * 24));
            const suffix = daysLeft === 1 ? 'day' : 'days';
            btn.innerHTML = `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Submit Payout Request <span class="text-[9px] opacity-70 ml-1">(${daysLeft} ${suffix} left)</span>`;
        } else {
            btn.disabled = true;
            btn.onclick = null;
            btn.classList.remove('btn-gradient');
            btn.classList.add('cursor-not-allowed');
            btn.style.cssText = 'background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);';
            const dateStr = nextDay.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            btn.innerHTML = `<svg class="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg> <span class="text-gray-500">Available on ${dateStr}</span>`;
        }
    }

    async function openPayoutModal() {
        const modal = document.getElementById('payout-modal');
        const content = document.getElementById('payout-modal-content');
        modal.classList.remove('hidden');
        requestAnimationFrame(() => {
            modal.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        });

        await loadPayoutScheduleFromSettings();

        const nextDate = getNextPayoutDate();
        document.getElementById('payout-next-date').textContent = nextDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        document.getElementById('payout-schedule-label').textContent = SCHEDULE_LABELS[_payoutSchedule] || _payoutSchedule;

        // Auto-fill wallet from saved settings
        const API = window.TFXS_API;
        if (API) {
            try {
                const affiliateId = API.getAffiliateId();
                const settingsRes = await API.fetchSettings(affiliateId);
                if (settingsRes.ok && settingsRes.data) {
                    if (settingsRes.data.wallet_address) {
                        document.getElementById('payout-wallet').value = settingsRes.data.wallet_address;
                    }
                    if (settingsRes.data.payment_method) {
                        const radio = document.querySelector(`input[name="payout_method"][value="${settingsRes.data.payment_method}"]`);
                        if (radio) radio.checked = true;
                    }
                    // Auto-payout gate
                    const apEnabled = settingsRes.data.auto_payout_enabled === 'true';
                    const apLocked = settingsRes.data.auto_payout_locked === 'true';
                    const submitBtn = document.getElementById('payout-submit-btn');
                    if (submitBtn && (apEnabled || apLocked)) {
                        submitBtn.disabled = true;
                        submitBtn.onclick = null;
                        submitBtn.classList.remove('btn-gradient', 'hover:opacity-90', 'shadow-lg', 'shadow-brand-600/20');
                        submitBtn.style.background = 'rgba(16,185,129,0.1)';
                        submitBtn.style.border = '1px solid rgba(16,185,129,0.3)';
                        submitBtn.style.cursor = 'default';
                        submitBtn.style.boxShadow = 'none';
                        submitBtn.onmouseenter = null;
                        submitBtn.onmouseleave = null;
                        const autoLabel = (window.TFXS_i18n && window.TFXS_i18n.t) ? window.TFXS_i18n.t('payout.autoEnabled') : 'AUTO-PAYOUT ENABLED';
                        submitBtn.innerHTML = '<svg class="w-4 h-4 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> <span class="text-emerald-400">' + autoLabel + '</span>';
                        return; // Don't load balance / override button state
                    }
                }
            } catch (_) {
                const cached = JSON.parse(localStorage.getItem('tfxs_settings') || '{}');
                if (cached.walletAddress) document.getElementById('payout-wallet').value = cached.walletAddress;
                if (cached.paymentMethod) {
                    const radio = document.querySelector(`input[name="payout_method"][value="${cached.paymentMethod}"]`);
                    if (radio) radio.checked = true;
                }
            }
        }
        if (API) {
            try {
                const affiliateId = API.getAffiliateId();
                const balRes = await API.fetchPayoutBalance(affiliateId);
                if (balRes.ok) {
                    const b = balRes.data;
                    _payoutAvailable = b.available;
                    _hasPendingRequest = !!b.has_pending_request;
                    document.getElementById('payout-available').textContent = '$' + b.available.toLocaleString('en-US', { minimumFractionDigits: 2 });
                    document.getElementById('payout-pending').textContent = '$' + b.pending.toLocaleString('en-US', { minimumFractionDigits: 2 });
                    document.getElementById('payout-earned').textContent = '$' + b.total_earned.toLocaleString('en-US', { minimumFractionDigits: 2 });
                    document.getElementById('payout-paid').textContent = '$' + b.total_paid.toLocaleString('en-US', { minimumFractionDigits: 2 });
                    document.getElementById('payout-withdrawal-amount').textContent = '$' + b.available.toLocaleString('en-US', { minimumFractionDigits: 2 });
                }

                // Check submit button state (pending request takes priority)
                updatePayoutSubmitButton();

                // Load payout history
                const histRes = await API.fetchPayoutHistory(affiliateId);
                if (histRes.ok && histRes.data.length > 0) {
                    const section = document.getElementById('payout-history-section');
                    const list = document.getElementById('payout-history-list');
                    section.classList.remove('hidden');
                    // Show only 3 most recent payouts in modal
                    const recentPayouts = histRes.data.slice(0, 3);
                    list.innerHTML = recentPayouts.map((p, idx) => {
                        const statusColors = {
                            pending: 'text-yellow-400 bg-yellow-500/10 border-yellow-500/20',
                            approved: 'text-blue-400 bg-blue-500/10 border-blue-500/20',
                            paid: 'text-green-400 bg-green-500/10 border-green-500/20',
                            rejected: 'text-red-400 bg-red-500/10 border-red-500/20'
                        };
                        const sc = statusColors[p.status] || statusColors.pending;
                        const date = new Date(p.requested_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const methodLabel = CRYPTO_DISPLAY[p.payment_method] || p.payment_method || '';
                        return `<div class="flex items-center justify-between p-2 rounded-lg bg-white/[0.02] border border-white/5">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-mono font-bold text-white">$${parseFloat(p.amount).toFixed(2)}</span>
                                <span class="text-[8px] text-gray-500">${methodLabel} · ${date}</span>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <button onclick='generatePayoutInvoice(${JSON.stringify(p).replace(/'/g, "&#39;")})' class="p-1 rounded hover:bg-white/10 text-gray-500 hover:text-white transition-colors" title="Download PDF Invoice">
                                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                </button>
                                <span class="text-[9px] font-bold uppercase px-2 py-0.5 rounded-full border ${sc}">${p.status}</span>
                            </div>
                        </div>`;
                    }).join('');
                    // Add "View all" link if more than 3 payouts
                    if (histRes.data.length > 3) {
                        list.innerHTML += `<a href="/reports.html" onclick="localStorage.setItem('reports_tab','payouts')" class="block text-center text-[10px] text-brand-500 hover:text-brand-400 font-bold uppercase tracking-wider mt-2 py-1">View all ${histRes.data.length} payouts in Reports →</a>`;
                    }
                }
            } catch (err) {
                console.warn('[Payout] Could not load balance:', err.message);
            }
        }
    }

    function closePayoutModal() {
        const modal = document.getElementById('payout-modal');
        const content = document.getElementById('payout-modal-content');
        modal.classList.add('opacity-0');
        content.classList.add('scale-95');
        setTimeout(() => modal.classList.add('hidden'), 300);
        document.getElementById('payout-msg').classList.add('hidden');
    }

    async function submitPayoutRequest() {
        const btn = document.getElementById('payout-submit-btn');
        const msg = document.getElementById('payout-msg');
        const amount = _payoutAvailable; // Always full balance
        const wallet = document.getElementById('payout-wallet').value.trim();
        const method = document.querySelector('input[name="payout_method"]:checked').value;

        // Validation
        if (amount < 100) {
            msg.className = 'text-center text-sm p-2.5 rounded-lg border border-red-500/30 bg-red-500/10 text-red-400';
            msg.textContent = `Minimum payout is $100. Your balance: $${amount.toFixed(2)}`;
            msg.classList.remove('hidden');
            return;
        }
        if (!wallet) {
            msg.className = 'text-center text-sm p-2.5 rounded-lg border border-red-500/30 bg-red-500/10 text-red-400';
            msg.textContent = 'Please enter your wallet address';
            msg.classList.remove('hidden');
            return;
        }

        btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...';
        btn.disabled = true;

        const API = window.TFXS_API;
        try {
            const affiliateId = API ? API.getAffiliateId() : null;
            const res = await API.requestPayout({
                affiliate_id: affiliateId,
                amount: amount,
                payment_method: method,
                wallet_address: wallet
            });

            if (!res.ok) throw new Error(res.error || 'Request failed');

            // Mark as pending — switch button to amber "awaiting review" immediately
            _hasPendingRequest = true;
            msg.classList.add('hidden');
            updatePayoutSubmitButton();

            // Refresh balance display after 2s
            setTimeout(() => openPayoutModal(), 2000);

        } catch (err) {
            const errText = err.message || '';
            if (errText.includes('kyc_required') || errText.includes('KYC')) {
                msg.className = 'text-center text-sm p-2.5 rounded-lg border border-amber-500/30 bg-amber-500/10 text-amber-400';
                msg.innerHTML = '<strong>KYC Required</strong><br><span class="text-[10px]">Please <a href="/settings#kyc-section" class="underline hover:text-white">verify your identity</a> before requesting a payout.</span>';
            } else {
                msg.className = 'text-center text-sm p-2.5 rounded-lg border border-red-500/30 bg-red-500/10 text-red-400';
                msg.textContent = errText;
            }
            msg.classList.remove('hidden');
            btn.innerHTML = '<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Submit Payout Request';
            btn.disabled = false;
        }
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closePayoutModal();
    });
    document.getElementById('payout-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('payout-modal')) closePayoutModal();
    });
    </script>

    </div><!-- end relative z-1 wrapper -->

    <!-- Auth Guard + Live Data Connectors -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/settings-loader.js"></script>
    <script src="js/dashboard.js"></script>
</body>
</html>